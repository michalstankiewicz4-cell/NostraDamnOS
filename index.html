<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIMP¬© Polityczny Informator, Model Predykcyjny</title>
    <link rel="icon" href="data:,">
    <meta name="author" content="Micha≈Ç Stankiewicz">
    <meta name="description" content="PIMP - System lokalnej analizy wypowiedzi parlamentarnych z API Sejmu RP. Autor: Micha≈Ç Stankiewicz. Wsp√≥≈Çtw√≥rcy: Claude Sonnet 4.5, GitHub Copilot">
    <link rel="stylesheet" href="style.css">
    
    <!-- ‚úÖ GEOLOKALIZACJA - AKTYWNA -->
    <script type="module">
        import { enforceEuropeOnly } from "./modules/geo.js";
        enforceEuropeOnly();
    </script>
</head>
<body>
    <!-- Project Metadata -->
    <script>
        window.PROJECT = {
            name: "PIMP \"puppy\"",
            version: "4.0.0",
            author: "Micha≈Ç Stankiewicz",
            contributors: "Claude Sonnet 4.5, GitHub Copilot",
            repository: "https://github.com/michalstankiewicz4-cell/NostraDamnOS"
        };

        function logProjectInfo() {
            console.log(`%c${window.PROJECT.name} v${window.PROJECT.version}`, 'font-weight: bold; font-size: 14px; color: #667eea;');
            console.log(`%cAutor: ${window.PROJECT.author} | Wsp√≥≈Çtw√≥rcy: ${window.PROJECT.contributors}`, 'font-size: 12px; color: #718096;');
        }

        async function loadProjectMetadata() {
            try {
                const response = await fetch('./project.json', { cache: 'no-store' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (data?.name) window.PROJECT.name = data.name;
                if (data?.version) window.PROJECT.version = data.version;
                if (data?.author?.name) window.PROJECT.author = data.author.name;
                if (data?.contributors) window.PROJECT.contributors = data.contributors;

                document.title = `${window.PROJECT.name} v${window.PROJECT.version}`;

                const headerTitle = document.querySelector('header h1');
                if (headerTitle) headerTitle.textContent = `üèõÔ∏è ${window.PROJECT.name}`;

                const versionEl = document.getElementById('projectVersion');
                if (versionEl) versionEl.textContent = `v${window.PROJECT.version}`;

                const programVersionEl = document.getElementById('programVersion');
                if (programVersionEl) programVersionEl.textContent = window.PROJECT.version;
                
            } catch (error) {
                console.warn('Nie uda≈Ço siƒô wczytaƒá project.json:', error);
            } finally {
                logProjectInfo();
            }
        }

        document.addEventListener('DOMContentLoaded', loadProjectMetadata);
    </script>
    
    <!-- Console Log Interceptor - catches ALL logs and redirects to floating console -->
    <script>
        // Buffer for early logs (before UI console exists)
        window.logBuffer = [];
        window.originalConsoleLog = console.log;

        // Log level colors (default adapts to console style)
        const LOG_COLORS = {
            default: '#1a202c',
            red:     '#f56565',
            green:   '#48bb78',
            yellow:  '#ecc94b',
            blue:    '#63b3ed'
        };

        // Map console style ‚Üí default log text color
        const STYLE_DEFAULT_COLORS = {
            'console-modern': '#1a202c'
        };

        // Called by style switcher to update default log color
        window.updateLogDefaultColor = function(styleClass) {
            const newColor = STYLE_DEFAULT_COLORS[styleClass] || '#1a202c';
            LOG_COLORS.default = newColor;

            // Recolor existing default-colored log lines (marked with data-default-color)
            const apiLogs = document.getElementById('apiLogs');
            if (apiLogs) {
                apiLogs.querySelectorAll('div[data-default-color]').forEach(line => {
                    line.style.color = newColor;
                });
                window.syncFloatingConsoleLogs && window.syncFloatingConsoleLogs();
            }
        };

        // Console lamp: green normally, red when error logged
        function updateConsoleLamp(color) {
            if (color === LOG_COLORS.red) {
                const lamp = document.getElementById('consoleLamp');
                if (lamp) lamp.className = 'floating-lamp floating-lamp-error';
            }
        }

        // Core logging function with color support
        function addLogLine(message, color) {
            const timestamp = new Date().toLocaleTimeString();
            const formattedLog = `[${timestamp}] ${message}`;
            const apiLogs = document.getElementById('apiLogs');

            updateConsoleLamp(color);

            const isDefault = !color || color === LOG_COLORS.default;

            if (apiLogs) {
                const line = document.createElement('div');
                line.textContent = formattedLog;
                line.style.fontSize = '0.85rem';
                line.style.fontFamily = 'monospace';
                line.style.lineHeight = '1.6';
                line.style.color = isDefault ? LOG_COLORS.default : color;
                if (isDefault) line.setAttribute('data-default-color', '');
                apiLogs.appendChild(line);
                apiLogs.scrollTop = apiLogs.scrollHeight;
                window.syncFloatingConsoleLogs && window.syncFloatingConsoleLogs();
            } else {
                window.logBuffer.push({ text: formattedLog, color: isDefault ? null : color });
            }
        }

        // Format args to string
        function formatArgs(args) {
            return args.map(arg => {
                if (typeof arg === 'object') {
                    try { return JSON.stringify(arg, null, 2); } catch { return String(arg); }
                }
                return String(arg);
            }).join(' ');
        }

        // Override console.log ‚Üí default color
        console.log = function(...args) {
            window.originalConsoleLog.apply(console, args);
            addLogLine(formatArgs(args), LOG_COLORS.default);
        };

        // Override console.error ‚Üí red
        const originalConsoleError = console.error;
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLogLine(formatArgs(args), LOG_COLORS.red);
        };

        // clog(level, ...args) ‚Äî colored console log
        // Levels: 'red' (error), 'green' (ok), 'yellow' (info), 'blue' (sql), 'default' (normal)
        window.clog = function(level, ...args) {
            const color = LOG_COLORS[level] || LOG_COLORS.default;
            window.originalConsoleLog.apply(console, [`[${level.toUpperCase()}]`, ...args]);
            addLogLine(formatArgs(args), color);
        };
    </script>
    
    <div class="container">
        <header>
            <h1>üèõÔ∏è Parlament P.I.M.P.</h1>
            <p>System lokalnej analizy wypowiedzi parlamentarnych | <span id="projectVersion">v4.0.0</span></p>
        </header>

        <!-- Top Info Bar -->
        <div id="topInfoBar" class="top-info-bar">
            <span id="topInfoText" class="top-info-text"></span>
        </div>



        <!-- MAIN - 4 SEKCJE Z NAWIGACJƒÑ -->
        <main class="app-sections-container">

            <!-- SEKCJA 1: FORMULARZ ETL -->
            <section class="app-section active" data-section="1">
                
                <div class="etl-panel">
                    <div class="etl-sidebar">
                        <h3>üìä Konfiguracja ETL</h3>
                        
                        <div class="summary-item">
                            <strong>Instytucja:</strong>
                            <span id="etlInstitution">Sejm</span>
                        </div>
                        
                        <div class="summary-item">
                            <strong>Kadencja:</strong>
                            <span id="etlTerm">10</span>
                        </div>
                        
                        <div class="summary-item">
                            <strong>Zakres:</strong>
                            <span id="etlRange">3 posiedzenia (1-3)</span>
                        </div>
                        
                        <div class="summary-item etl-summary-column">
                            <strong>Dane:</strong>
                            <div class="summary-data-list" id="etlData">wypowiedzi</div>
                        </div>
                        
                        <div class="estimate-box">
                            <div class="estimate-title">üí° Estymacja</div>
                            <div class="estimate-grid">
                                <div class="estimate-row">
                                    <span class="estimate-label">Rozmiar:</span>
                                    <span class="estimate-value" id="etlSize">~700 KB</span>
                                </div>
                                <div class="estimate-row">
                                    <span class="estimate-label">Czas:</span>
                                    <span class="estimate-value" id="etlTime">~10-15s</span>
                                </div>
                                <div class="estimate-row estimate-row-last">
                                    <span class="estimate-label">Requesty:</span>
                                    <span class="estimate-value" id="etlRequests">~25</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="etl-rodo-box">
                            <label class="etl-rodo-label">
                                <input type="checkbox" id="etlRodoFilter" checked disabled>
                                <span class="etl-rodo-span">üîí Filtr RODO (zawsze aktywny)</span>
                            </label>
                            <div class="etl-rodo-description">
                                ‚úì Usuwa dane wra≈ºliwe: email, telefon, PESEL
                            </div>
                        </div>
                        
                        <div class="etl-relative-container">
                            <input type="checkbox" id="fullDatabaseCheckbox" class="btn-checkbox">
                            <button class="etl-btn etl-btn-primary" id="etlFetchBtn">
                                üì• Pobierz/Zaktualizuj dane
                            </button>
                        </div>
                        
                        <button class="etl-btn etl-btn-verify" id="etlVerifyBtn">
                            üîç Sprawd≈∫ niezgodno≈õci
                        </button>
                        <button class="etl-btn etl-btn-danger" id="etlClearBtn">
                            üóëÔ∏è Wyczy≈õƒá bazƒô
                        </button>
                    </div>
                    
                    <div class="etl-main">
                        <!-- Instytucja -->
                        <fieldset class="etl-fieldset">
                            <legend>üèõÔ∏è Instytucja</legend>
                            <div class="etl-radio-group">
                                <label class="etl-radio-option">
                                    <input type="radio" name="etlInst" value="sejm" checked> Sejm <span id="etlTermCountSejm" class="term-count"></span>
                                </label>
                                <label class="etl-radio-option">
                                    <input type="radio" name="etlInst" value="senat"> Senat <span id="etlTermCountSenat" class="term-count"></span>
                                </label>
                            </div>
                        </fieldset>
                        
                        <!-- Kadencja -->
                        <fieldset class="etl-fieldset">
                            <legend>üìÖ Kadencja</legend>
                            <select id="etlTermSelect" class="form-control">
                                <option value="10">10. kadencja (2023-obecnie)</option>
                                <option value="9">9. kadencja (2019-2023)</option>
                                <option value="8">8. kadencja (2015-2019)</option>
                                <option value="7">7. kadencja (2011-2015)</option>
                            </select>
                            <span id="etlSittingsCount" class="term-count"></span>
                        </fieldset>
                        
                        <!-- Zakres posiedze≈Ñ -->
                        <fieldset class="etl-fieldset">
                            <legend>üéØ Zakres posiedze≈Ñ</legend>
                            <div class="etl-input-group">
                                <span id="etlRangeFromLabel" class="etl-input-label">od</span>
                                <input type="number" id="etlRangeFrom" value="1" min="1" class="etl-number-input">
                                <span id="etlRangeToLabel" class="etl-input-label">do:</span>
                                <input type="number" id="etlRangeTo" value="3" min="1" class="etl-number-input">
                            </div>
                        </fieldset>
                        
                        <!-- Dane podstawowe -->
                        <fieldset class="etl-fieldset">
                            <legend>üìã Dane podstawowe</legend>
                            <div class="etl-section-hint">Zawsze pobierane</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlDeputies" checked disabled>
                                <label for="etlDeputies">Pos≈Çowie/Senatorowie</label>
                                <span class="badge badge-size">50 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlSittings" checked disabled>
                                <label for="etlSittings">Posiedzenia (lista)</label>
                                <span class="badge badge-size">20 KB</span>
                            </div>
                        </fieldset>
                        
                        <!-- Dane per posiedzenie -->
                        <fieldset class="etl-fieldset">
                            <legend>üìù Dane per posiedzenie</legend>
                            <div class="etl-section-hint">Incremental (per posiedzenie)</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlTranscripts" data-size="400" checked>
                                <label for="etlTranscripts">Wypowiedzi</label>
                                <span id="etlTranscriptsCount" class="term-count"></span>
                                <span class="badge badge-size">400 KB/pos.</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlVotings" data-size="15">
                                <label for="etlVotings">G≈Çosowania</label>
                                <span id="etlVotingsCount" class="term-count"></span>
                                <span class="badge badge-size">15 KB/pos.</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlVotes" data-size="1200">
                                <label for="etlVotes">G≈Çosy indywidualne <small style="color:var(--text-secondary)">(zliczane, nie pobierane)</small></label>
                                <span id="etlVotesCount" class="term-count"></span>
                                <span class="badge badge-size">1.2 MB/pos.</span>
                            </div>
                        </fieldset>
                        
                        <!-- Dane per kadencja -->
                        <fieldset class="etl-fieldset">
                            <legend>üóÇÔ∏è Dane per kadencja</legend>
                            <div class="etl-section-hint">Ca≈Ça kadencja (du≈ºe!)</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlInterpellations" data-size="4000">
                                <label for="etlInterpellations">Interpelacje</label>
                                <span id="etlInterpellationsCount" class="term-count"></span>
                                <span class="badge badge-size">~4 MB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlWrittenQuestions" data-size="800">
                                <label for="etlWrittenQuestions">Zapytania pisemne</label>
                                <span id="etlWrittenQuestionsCount" class="term-count"></span>
                                <span class="badge badge-size">~800 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlBills" data-size="700">
                                <label for="etlBills">Projekty ustaw</label>
                                <span id="etlBillsCount" class="term-count"></span>
                                <span class="badge badge-size">~700 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlLegalActs" data-size="500">
                                <label for="etlLegalActs">Ustawy (akty prawne)</label>
                                <span id="etlLegalActsCount" class="term-count"></span>
                                <span class="badge badge-size">~500 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlDisclosures" data-size="500" disabled>
                                <label for="etlDisclosures" style="opacity:0.4">O≈õwiadczenia majƒÖtkowe <small>(API niedostƒôpne)</small></label>
                            </div>
                        </fieldset>
                        
                        <!-- Komisje -->
                        <fieldset class="etl-fieldset">
                            <legend>üè¢ Komisje</legend>
                            <div class="etl-section-hint">Wybierz dane komisji</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlCommitteeSittings" data-size="80">
                                <label for="etlCommitteeSittings">Posiedzenia komisji</label>
                                <span id="etlCommitteeSittingsCount" class="term-count"></span>
                                <span class="badge badge-size">80 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlCommitteeStatements" data-size="200">
                                <label for="etlCommitteeStatements">Wypowiedzi komisji</label>
                                <span id="etlCommitteeStatementsCount" class="term-count"></span>
                                <span class="badge badge-size">200 KB</span>
                            </div>
                            
                            <div class="etl-fieldset-margin">
                                <label class="etl-checkbox-label">
                                    üìã Wybierz komisje:
                                </label>
                                <select id="etlCommitteeSelect" class="form-control etl-committee-select" multiple size="8">
                                    <option value="all" selected>‚úì Wszystkie komisje</option>
                                </select>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <!-- Hidden Progress & Logs (for floating console) -->
                <div id="apiProgress" style="display:none;">
                    <div class="api-progress-bar-wrapper">
                        <div id="apiProgressBar" class="api-progress-bar"></div>
                    </div>
                    <div id="apiProgressText" class="api-progress-text">Postƒôp: 0%</div>
                    <div id="apiLogs" class="api-logs"></div>
                </div>
                
                <!-- Status -->
                <div id="apiStatus" class="api-status-box">
                    <div class="api-status-title">‚úÖ Status bazy:</div>
                    <div id="apiStatusDetails" class="api-status-details">Baza pusta - pobierz dane</div>
                </div>
            </section>

            <!-- SEKCJA 2: PODSUMOWANIE DANYCH -->
            <section class="app-section" data-section="2" style="display:none;">

                <!-- Panel: Zlecone vs Pobrane -->
                <div id="fetchOverview" class="fetch-overview" style="display:none;">
                    <div class="fetch-overview-col">
                        <h4>Zlecone</h4>
                        <table class="fetch-overview-table">
                            <tbody>
                                <tr><td>Instytucja</td><td id="fovInst">‚Äî</td></tr>
                                <tr><td>Kadencja</td><td id="fovKadencja">‚Äî</td></tr>
                                <tr><td>Zakres posiedze≈Ñ</td><td id="fovRange">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane podstawowe</td></tr>
                                <tr><td>Pos≈Çowie</td><td id="fovReqDeputies">‚Äî</td></tr>
                                <tr><td>Posiedzenia</td><td id="fovReqSittings">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per posiedzenie</td></tr>
                                <tr><td>Dni obrad</td><td id="fovReqSessionDays">‚Äî</td></tr>
                                <tr><td>Wypowiedzi</td><td id="fovReqTranscripts">‚Äî</td></tr>
                                <tr><td>G≈Çosowania</td><td id="fovReqVotings">‚Äî</td></tr>
                                <tr><td>G≈Çosy indywidualne</td><td id="fovReqVotes">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per kadencja</td></tr>
                                <tr><td>Interpelacje</td><td id="fovReqInterpellations">‚Äî</td></tr>
                                <tr><td>Zapytania pisemne</td><td id="fovReqQuestions">‚Äî</td></tr>
                                <tr><td>Projekty ustaw</td><td id="fovReqBills">‚Äî</td></tr>
                                <tr><td>Ustawy</td><td id="fovReqActs">‚Äî</td></tr>
                                <tr><td>O≈õwiadczenia</td><td id="fovReqDisclosures">‚Äî</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="fetch-overview-col">
                        <h4>Pobrane</h4>
                        <table class="fetch-overview-table">
                            <tbody>
                                <tr><td>Instytucja</td><td id="fovGotInst">‚Äî</td></tr>
                                <tr><td>Kadencja</td><td id="fovGotKadencja">‚Äî</td></tr>
                                <tr><td>Posiedzenia w zakresie</td><td id="fovGotRange">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane podstawowe</td></tr>
                                <tr><td>Pos≈Çowie</td><td id="fovGotDeputies">‚Äî</td></tr>
                                <tr><td>Posiedzenia</td><td id="fovGotSittings">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per posiedzenie</td></tr>
                                <tr><td>Dni obrad</td><td id="fovGotSessionDays">‚Äî</td></tr>
                                <tr><td>Wypowiedzi</td><td id="fovGotTranscripts">‚Äî</td></tr>
                                <tr><td>G≈Çosowania</td><td id="fovGotVotings">‚Äî</td></tr>
                                <tr><td>G≈Çosy indywidualne</td><td id="fovGotVotes">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per kadencja</td></tr>
                                <tr><td>Interpelacje</td><td id="fovGotInterpellations">‚Äî</td></tr>
                                <tr><td>Zapytania pisemne</td><td id="fovGotQuestions">‚Äî</td></tr>
                                <tr><td>Projekty ustaw</td><td id="fovGotBills">‚Äî</td></tr>
                                <tr><td>Ustawy</td><td id="fovGotActs">‚Äî</td></tr>
                                <tr><td>O≈õwiadczenia</td><td id="fovGotDisclosures">‚Äî</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="summary-container" id="summaryContainer"></div>

                <div class="summary-info" id="summaryInfo" style="display:none;">
                    <p><strong>Ostatnia aktualizacja:</strong> <span id="lastUpdate">Brak danych</span></p>
                    <p><strong>Kadencja:</strong> <span id="summaryTerm">-</span></p>
                    <p><strong>Instytucja:</strong> <span id="summaryInstitution">-</span></p>
                    <p><strong>≈ÅƒÖcznie rekord√≥w:</strong> <span id="summaryTotal">0</span></p>
                    <p id="lastFetchInfo" style="display:none;"><strong>Ostatnie pobieranie:</strong> <span id="lastFetchDetails">-</span></p>
                </div>

                <div id="summaryTableSection" class="summary-table-section" style="display:none;">
                    <div class="summary-table-header">
                        <h3 id="summaryTableTitle"></h3>
                        <button id="summaryTableClose" class="summary-table-close" title="Zamknij">&times;</button>
                    </div>
                    <div id="summaryTableWrap" class="summary-table-wrap"></div>
                </div>

                <div class="summary-actions" id="summaryActions" style="margin-top:12px; display:flex; gap:10px;">
                    <button id="summaryImportDb" class="console-style-btn">üì• Import bazy</button>
                    <button id="summaryExportDb" class="console-style-btn">üì§ Export bazy</button>
                </div>

                <div class="summary-placeholder" id="summaryPlaceholder">
                    <p>üì• Pobierz dane w sekcji ETL, aby zobaczyƒá szczeg√≥≈Çowe statystyki</p>
                </div>
            </section>

            <!-- SEKCJA 3: AI ASYSTENT -->
            <section class="app-section" data-section="3" style="display:none;">
                <div class="ai-two-columns">

                <!-- KOLUMNA 1: Asystent AI -->
                <div class="ai-column ai-column-chat">
                <h3>ü§ñ Asystent AI</h3>
                <div class="ai-chat-fullscreen">
                    <div class="chat-config">
                        <div class="chat-config-row">
                            <label for="aiModelSelect">Model AI:</label>
                            <div class="model-select-wrapper">
                                <label class="chat-filter-checkbox" title="Poka≈º wszystkie modele">
                                    <input type="checkbox" id="showAllModels" checked>
                                </label>
                                <select id="aiModelSelect">
                                    <option value="openai">OpenAI GPT-4</option>
                                    <option value="claude">Anthropic Claude 3.5</option>
                                    <optgroup label="üî• Gemini - G≈Ç√≥wne">
                                        <option value="gemini-3-flash">Gemini 3 Flash Preview</option>
                                        <option value="gemini-3-pro">Gemini 3 Pro Preview</option>
                                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                    </optgroup>
                                    <optgroup label="‚ö° Gemini 2.0">
                                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                                        <option value="gemini-exp-1206">Gemini Exp 1206</option>
                                    </optgroup>
                                    <optgroup label="üìå Latest">
                                        <option value="gemini-flash-latest">Gemini Flash Latest</option>
                                        <option value="gemini-pro-latest">Gemini Pro Latest</option>
                                    </optgroup>
                                    <optgroup label="üé® Image & Specjalne">
                                        <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image</option>
                                        <option value="gemini-3-pro-image">Gemini 3 Pro Image</option>
                                        <option value="gemini-computer-use">Computer Use Preview</option>
                                        <option value="deep-research-pro">Deep Research Pro</option>
                                        <option value="gemini-robotics">Robotics 1.5 Preview</option>
                                    </optgroup>
                                    <optgroup label="ü§ñ Gemma (Open Models)">
                                        <option value="gemma-12b">Gemma 3 12B</option>
                                        <option value="gemma-27b">Gemma 3 27B</option>
                                    </optgroup>
                                </select>
                                <button id="toggleFavoriteBtn" class="toggle-favorite-btn" title="Dodaj/usu≈Ñ z ulubionych">‚≠ê</button>
                            </div>
                        </div>
                        
                        <div class="chat-config-row">
                            <a id="apiKeyLink" href="https://platform.openai.com/api-keys" target="_blank" class="chat-api-link">
                                üîë Wygeneruj klucz API
                            </a>
                        </div>
                        
                        <div class="chat-config-row">
                            <label for="aiApiKey">Klucz API:</label>
                            <input type="password" id="aiApiKey" placeholder="sk-..." />
                        </div>
                        
                        <div class="chat-config-row">
                            <button id="checkModelsBtn" class="chat-check-models-btn">
                                üîç Sprawd≈∫ dostƒôpne modele Gemini
                            </button>
                        </div>
                        
                        <div class="chat-config-row">
                            <details class="chat-favorites-section">
                                <summary class="chat-favorites-toggle">‚≠ê ZarzƒÖdzaj ulubionymi</summary>
                                <div id="favoritesList" class="favorites-list"></div>
                                <div class="favorites-help">Kliknij ‚≠ê przy wybranym modelu w li≈õcie powy≈ºej, aby dodaƒá do ulubionych</div>
                            </details>
                        </div>
                    </div>
                    
                    <div id="chatMessages" class="chat-messages-fullscreen"></div>
                    
                    <div class="chat-input-area">
                        <textarea id="chatInput" placeholder="Zadaj pytanie o dane parlamentarne..." rows="1"></textarea>
                        <button id="sendChatBtn" title="Wy≈õlij wiadomo≈õƒá">üì§</button>
                    </div>
                </div>
                </div><!-- /ai-column-chat -->

                <!-- KOLUMNA 2: Modele Lokalne -->
                <div class="ai-column ai-column-models">
                <h3>üîß Modele Lokalne</h3>
                <section class="models-section">
                    <div class="model-status">
                        <div class="model-item">
                            <span class="model-name">WebLLM (4B)</span>
                            <span id="webllmStatus" class="status">‚è≥ Nieaktywny</span>
                        </div>
                        <div class="model-item">
                            <span class="model-name">Transformers.js</span>
                            <span id="transformersStatus" class="status">‚è≥ Nieaktywny</span>
                        </div>
                    </div>
                    <button id="loadModels" class="btn btn-primary">Za≈Çaduj modele lokalne</button>
                    <div class="analysis-buttons" style="margin-top: 10px;">
                        <button id="analyzeSentiment" class="btn" disabled>Analiza sentymentu</button>
                        <button id="analyzeTopics" class="btn" disabled>Analiza temat√≥w</button>
                        <button id="generateSummary" class="btn" disabled>Generuj podsumowanie</button>
                        <button id="compareSpeeches" class="btn" disabled>Por√≥wnaj wypowiedzi</button>
                    </div>
                    <div id="results" style="margin-top: 10px;"></div>
                </section>
                </div><!-- /ai-column-models -->

                </div><!-- /ai-two-columns -->
            </section>

            <!-- SEKCJA 4: WYKRESY & ANALITYKA -->
            <section class="app-section" data-section="4" style="display:none;">

                <div id="chartsGrid" class="charts-grid">
                    <div class="chart-card" id="chartKluby">
                        <div class="chart-card-header">
                            <h4>Rozk≈Çad klub√≥w parlamentarnych</h4>
                            <button class="chart-refresh-btn" data-chart="kluby" title="Aktualizuj">üîÑ</button>
                        </div>
                        <canvas id="canvasKluby"></canvas>
                        <div class="chart-no-data">Brak danych ‚Äî pobierz pos≈Ç√≥w w ETL</div>
                    </div>
                    <div class="chart-card" id="chartTopPoslowie">
                        <div class="chart-card-header">
                            <h4>Top 10 najaktywniejszych pos≈Ç√≥w</h4>
                            <button class="chart-refresh-btn" data-chart="topPoslowie" title="Aktualizuj">üîÑ</button>
                        </div>
                        <canvas id="canvasTopPoslowie"></canvas>
                        <div class="chart-no-data">Brak danych ‚Äî pobierz wypowiedzi w ETL</div>
                    </div>
                    <div class="chart-card" id="chartGlosowania">
                        <div class="chart-card-header">
                            <h4>Wyniki g≈Çosowa≈Ñ</h4>
                            <button class="chart-refresh-btn" data-chart="glosowania" title="Aktualizuj">üîÑ</button>
                        </div>
                        <canvas id="canvasGlosowania"></canvas>
                        <div class="chart-no-data">Brak danych ‚Äî pobierz g≈Çosowania w ETL</div>
                    </div>
                    <div class="chart-card" id="chartCustom">
                        <div class="chart-card-header">
                            <select id="customChartSelect" class="chart-select">
                                <option value="glosowaniaTime">G≈Çosowania w czasie</option>
                                <option value="komisje">Aktywno≈õƒá komisji</option>
                                <option value="interpelacje">Interpelacje wg pos≈Ç√≥w</option>
                                <option value="frekwencja">Frekwencja g≈Çosowa≈Ñ</option>
                            </select>
                            <button class="chart-refresh-btn" data-chart="custom" title="Aktualizuj">üîÑ</button>
                        </div>
                        <canvas id="canvasCustom"></canvas>
                        <div class="chart-no-data">Brak danych ‚Äî pobierz odpowiednie dane w ETL</div>
                    </div>
                    <div class="chart-card" id="chartNajmniejAktywni">
                        <div class="chart-card-header">
                            <h4>Top 20 najmniej aktywnych pos≈Ç√≥w</h4>
                            <button class="chart-refresh-btn" data-chart="najmniejAktywni" title="Aktualizuj">üîÑ</button>
                        </div>
                        <canvas id="canvasNajmniejAktywni"></canvas>
                        <div class="chart-no-data">Brak danych ‚Äî pobierz wypowiedzi w ETL</div>
                    </div>
                    <div class="chart-card" id="chartNajmniejAktywneKluby">
                        <div class="chart-card-header">
                            <h4>Top 20 najmniej aktywnych klub√≥w</h4>
                            <button class="chart-refresh-btn" data-chart="najmniejAktywneKluby" title="Aktualizuj">üîÑ</button>
                        </div>
                        <canvas id="canvasNajmniejAktywneKluby"></canvas>
                        <div class="chart-no-data">Brak danych ‚Äî pobierz wypowiedzi i pos≈Ç√≥w w ETL</div>
                    </div>
                    <div class="chart-card chart-card-wide" id="chartHeatmap">
                        <div class="chart-card-header">
                            <h4>Heatmapa frekwencji</h4>
                            <div class="heatmap-controls">
                                <select id="heatmapXAxis" class="chart-select">
                                    <option value="posiedzenia">O≈õ X: Posiedzenia</option>
                                    <option value="glosowania">O≈õ X: G≈Çosowania</option>
                                </select>
                                <select id="heatmapYAxis" class="chart-select">
                                    <option value="poslowie">O≈õ Y: Pos≈Çowie</option>
                                    <option value="kluby">O≈õ Y: Kluby</option>
                                </select>
                                <select id="heatmapColor" class="chart-select">
                                    <option value="obecnosc">Kolor: Obecno≈õƒá</option>
                                    <option value="za">Kolor: G≈Çosy Za</option>
                                    <option value="przeciw">Kolor: G≈Çosy Przeciw</option>
                                    <option value="wstrzymal">Kolor: Wstrzyma≈Ç siƒô</option>
                                </select>
                            </div>
                            <button class="chart-refresh-btn" data-chart="heatmap" title="Aktualizuj">üîÑ</button>
                        </div>
                        <canvas id="canvasHeatmap"></canvas>
                        <div class="chart-no-data">Brak danych ‚Äî pobierz g≈Çosy i pos≈Ç√≥w w ETL</div>
                    </div>
                </div>
            </section>
            <!-- SEKCJA 5: Ustawienia programu -->
            <section class="app-section" data-section="5" style="display:none;">
                <!-- Sekcja 2: Zmiana jƒôzyka -->
                <div class="console-style-panel">
                    <div class="console-style-header">
                        <h3>Jƒôzyk / Language</h3>
                    </div>
                    <div class="console-style-body">
                        <div class="console-style-options">
                               <button id="langPL" class="console-style-btn active" title="Polski">üáµüá± Polski</button>
                               <button id="langEN" class="console-style-btn" title="English">üá¨üáß English</button>
                               <button id="langUA" class="console-style-btn" title="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</button>
                        </div>
                    </div>
                </div>
                <!-- Sekcja 3: ZarzƒÖdzanie pamiƒôciƒÖ przeglƒÖdarki -->
                <div class="console-style-panel">
                    <div class="console-style-header">
                        <h3>Pamiƒôƒá przeglƒÖdarki</h3>
                    </div>
                    <div class="console-style-body">
                        <div class="console-style-description">
                            <p>Resetuj zapisane pozycje przycisk√≥w oraz ustawienia interfejsu do warto≈õci domy≈õlnych.</p>
                        </div>
                        <div class="console-style-options">
                               <button id="btnResetMemory" class="console-style-btn console-style-btn-danger">Reset pamiƒôci</button>
                        </div>
                    </div>
                </div>
                <!-- Sekcja 3: Widoczno≈õƒá element√≥w UI -->
                <div class="console-style-panel">
                    <div class="console-style-header">
                        <h3>Widoczno≈õƒá element√≥w</h3>
                    </div>
                    <div class="console-style-body">
                        <div class="settings-checkboxes">
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleFloatingBtns" checked>
                                <span>Przyciski po lewej stronie</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleTopBar" checked>
                                <span>Pasek informacyjny (g√≥ra)</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBottomBar" checked>
                                <span>Pasek statusu (d√≥≈Ç)</span>
                            </label>
                        </div>
                        <div class="settings-checkboxes" style="margin-top:10px">
                            <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:6px">Przyciski boczne:</p>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBtnImport" checked>
                                <span>Import bazy</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBtnExport" checked>
                                <span>Export bazy</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBtnAi" checked>
                                <span>Nawigator</span>
                                <select id="btnAiTargetSelect" style="margin-left:8px;font-size:0.75rem;padding:1px 4px;background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px">
                                    <option value="1">ETL</option>
                                    <option value="2">Podsumowanie</option>
                                    <option value="3" selected>AI Asystent</option>
                                    <option value="4">Wykresy</option>
                                    <option value="5">Ustawienia</option>
                                </select>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBtnAbout" checked>
                                <span>Informacje o wersji</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBtnLanguage">
                                <span style="opacity:0.5">Zmiana jƒôzyka (niedostƒôpna)</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBtnHelp" checked>
                                <span>Podpowiedzi</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBtnReset">
                                <span>Reset pamiƒôci</span>
                            </label>
                        </div>
                        <div class="settings-checkboxes" style="margin-top:10px">
                            <p style="font-size:0.85rem;color:var(--text-secondary);margin-bottom:6px">Elementy paska statusu:</p>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarVersion" checked>
                                <span>Wersja</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarDb" checked>
                                <span>Baza</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarAi" checked>
                                <span>AI</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarLoad" checked>
                                <span>Load</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarMemory">
                                <span>Memory</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarStorage">
                                <span>Storage</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarCache">
                                <span>Cache</span>
                            </label>
                            <label class="settings-checkbox-label">
                                <input type="checkbox" id="toggleBarConsole" checked>
                                <span>Konsola</span>
                            </label>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- BOTTOM NAVIGATION BAR -->
        <nav class="bottom-nav">
            <div class="nav-item active" data-section="1">
                <div class="nav-icon">üì•</div>
                <div class="nav-label">ETL</div>
            </div>
            <div class="nav-item" data-section="2">
                <div class="nav-icon">üìä</div>
                <div class="nav-label">Podsumowanie</div>
            </div>
            <div class="nav-item" data-section="3">
                <div class="nav-icon">ü§ñ</div>
                <div class="nav-label">AI Asystent</div>
            </div>
            <div class="nav-item" data-section="4">
                <div class="nav-icon">üìà</div>
                <div class="nav-label">Wykresy</div>
            </div>
            <div class="nav-item" data-section="5">
                <div class="nav-icon">‚öôÔ∏è</div>
                <div class="nav-label">Ustawienia</div>
            </div>
        </nav>

        <footer>
            <p>
                üöÄ Projekt open-source | 
                <a href="https://github.com/michalstankiewicz4-cell/NostraDamnOS" target="_blank">GitHub</a>
            </p>
        </footer>
    </div>

    <!-- Floating UI Buttons -->
    <button id="aiChatBtn" class="floating-btn btn-ai-chat" title="AI Asystent">ü§ñ</button>
    <button id="exportDbBtn" class="floating-btn btn-export" title="Export bazy danych">üì§</button>
    <button id="importDbBtn" class="floating-btn btn-import" title="Import bazy danych">üì•</button>
    <button id="helpBtn" class="floating-btn btn-help" title="Podpowiedzi (TODO)">‚ùì</button>
    <button id="aboutBtn" class="floating-btn btn-rodo" title="O projekcie">‚ÑπÔ∏è</button>
    <button id="languageBtn" class="floating-btn btn-language" title="Zmie≈Ñ jƒôzyk (TODO)">üáµüá±</button>
    <button id="resetMemoryBtn" class="floating-btn btn-reset-memory" title="Reset pamiƒôci" style="display:none">üóëÔ∏è</button>

    <!-- Floating Status Bar (Bottom) -->
    <div id="floatingStatusBar" class="floating-status-bar">

        <!-- [Wersja] -->
        <div id="versionSection" class="status-bar-section">
            <span class="status-bar-label">v<span id="programVersion">4.0.0</span></span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Baza] -->
        <div id="statusIndicators" class="status-bar-section">
            <span class="status-bar-label">Baza:</span>
            <div class="status-bar-lamps">
                <div class="floating-lamp floating-lamp-error" id="floatingStatusDbState" title="Stan bazy danych"></div>
                <div class="floating-lamp floating-lamp-ok" id="floatingStatusRecords" title="Stan rekord√≥w w API"></div>
                <div class="floating-lamp floating-lamp-ok" id="floatingStatusValidity" title="Stan poprawno≈õci danych"></div>
            </div>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [AI] -->
        <div id="aiStatusSection" class="status-bar-section">
            <span class="status-bar-label">AI:</span>
            <div id="aiStatusLamps" class="status-bar-lamps"></div>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Load] -->
        <div id="etlProgressSection" class="status-bar-section" title="Pasek ≈Çadowania danych z API">
            <span class="status-bar-label">Load:</span>
            <div id="loadLamp" class="floating-lamp floating-lamp-idle" title="Status ≈Çadowania"></div>
            <div class="progress-track">
                <div id="etlProgressBar" class="progress-bar" style="width:0%"></div>
            </div>
            <span id="etlProgressPercent" class="progress-percent" style="display:none;">0%</span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Memory] -->
        <div id="memorySection" class="status-bar-section" title="Zajƒôto≈õƒá pamiƒôci przeglƒÖdarki">
            <span class="status-bar-label">Memory:</span>
            <div id="memoryLamp" class="floating-lamp floating-lamp-ok" title="Stan pamiƒôci"></div>
            <div class="progress-track">
                <div id="memoryProgressBar" class="progress-bar" style="width:0%"></div>
            </div>
            <span id="memoryPercent" class="progress-percent">0%</span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Storage] -->
        <div id="storageSection" class="status-bar-section" title="Zajƒôto≈õƒá localStorage (limit ~5 MB)">
            <span class="status-bar-label">Storage:</span>
            <div id="storageLamp" class="floating-lamp floating-lamp-ok" title="Stan localStorage"></div>
            <div class="progress-track">
                <div id="storageProgressBar" class="progress-bar" style="width:0%"></div>
            </div>
            <span id="storagePercent" class="progress-percent">0%</span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Cache] -->
        <div id="cacheSection" class="status-bar-section" title="Zajƒôto≈õƒá cache bazy danych">
            <span class="status-bar-label">Cache:</span>
            <div id="cacheBar" class="cache-bar"></div>
        </div>

        <!-- Spacer -->
        <div class="status-bar-spacer"></div>

        <div class="status-bar-separator"></div>

        <!-- [Konsola] -->
        <div id="consoleSection" class="status-bar-section status-bar-console" title="Otw√≥rz konsolƒô (Ctrl+`)">
            <div id="consoleLamp" class="floating-lamp floating-lamp-ok" title="Status konsoli"></div>
            <span class="status-bar-label">KONSOLA</span>
        </div>
    </div>

    <!-- Floating Console Panel -->
    <div id="floatingConsolePanel" class="floating-console-panel">
        <div class="floating-console-header">
            <span class="floating-console-title">üìã Console</span>
            <button id="closeFloatingConsole" class="floating-console-close">√ó</button>
        </div>
        <div id="floatingConsoleLogs" class="floating-console-logs">
        </div>
    </div>

    <!-- Modu≈Çy -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script type="module" src="api-handler-v2.js"></script>
    <script type="module">
        // Import needed functions
        import { getCacheStatus, runPipeline, buildConfigFromUI } from './pipeline.js';

        // Startup integrity check
        async function runStartupCheck() {
            try {
                // Wait for db2.database to be available (max 5 seconds)
                for (let i = 0; i < 50; i++) {
                    if (window.db2?.database) break;
                    await new Promise(r => setTimeout(r, 100));
                }

                if (!window.db2?.database) {
                    console.warn('[Startup Check] db2 database not initialized');
                    return;
                }

                const cache = getCacheStatus(window.db2);
                console.log('[Startup Check] Cache status:', cache);

                // Skip if database is empty
                if (!cache.initialized || !cache.totalRecords) {
                    console.log('[Startup Check] ‚úÖ Database empty - no verification needed');
                    return;
                }

                console.log('[Startup Check] Running verification...');
                
                const verifyConfig = buildConfigFromUI();
                verifyConfig.fetchMode = 'verify';
                
                await runPipeline(verifyConfig, {
                    onProgress: (msg) => console.log('[Verify]', msg),
                    onComplete: (result) => {
                        const hasDiscrepancies = result.discrepancies && Object.keys(result.discrepancies).length > 0;
                        if (hasDiscrepancies) {
                            console.warn('[Startup Check] ‚ö†Ô∏è Discrepancies found:', result.discrepancies);
                        } else {
                            console.log('[Startup Check] ‚úÖ Database matches API');
                        }
                    }
                });
            } catch (err) {
                console.error('[Startup Check] Error:', err);
            }
        }

        // Run check after page loads
        document.addEventListener('DOMContentLoaded', () => {
            runStartupCheck().catch(err => console.error('[Startup] Fatal error:', err));
        });

        // Expose for debugging
        window.runStartupCheck = runStartupCheck;
    </script>
    <script type="module" src="etl-bridge.js"></script>
    <script type="module" src="models.js"></script>
    <script type="module" src="modules/toast.js"></script>

        <!-- Konsola: domy≈õlny styl -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                document.body.classList.add('console-modern');
                window.updateLogDefaultColor && window.updateLogDefaultColor('console-modern');
            });
        </script>

        <!-- Reset pamiƒôci przeglƒÖdarki -->
        <script type="module">
            import { resetFloatingButtonPositions } from './modules/floating-drag.js';

            document.addEventListener('DOMContentLoaded', () => {
                const resetBtn = document.getElementById('btnResetMemory');
                resetBtn?.addEventListener('click', () => {
                    if (confirm('Czy na pewno chcesz zresetowaƒá pamiƒôƒá przeglƒÖdarki?\n\nTo usunie zapisane pozycje przycisk√≥w i ustawienia interfejsu.')) {
                        resetFloatingButtonPositions();
                        localStorage.removeItem('uiVisibility');
                        location.reload();
                    }
                });
            });
        </script>
    
    <!-- Memory Usage Monitor -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const memBar = document.getElementById('memoryProgressBar');
                const memPct = document.getElementById('memoryPercent');
                const memLamp = document.getElementById('memoryLamp');

                function updateMemory() {
                    if (performance && performance.memory) {
                        const used = performance.memory.usedJSHeapSize;
                        const total = performance.memory.jsHeapSizeLimit;
                        const pct = Math.round((used / total) * 100);
                        memBar.style.width = pct + '%';
                        memPct.textContent = pct + '%';
                        memBar.style.background = pct > 80 ? '#f56565' : pct > 50 ? '#f6ad55' : '#48bb78';

                        if (memLamp) {
                            memLamp.className = 'floating-lamp';
                            if (pct > 90) {
                                memLamp.classList.add('floating-lamp-error');
                            } else if (pct > 70) {
                                memLamp.classList.add('floating-lamp-warning');
                            } else {
                                memLamp.classList.add('floating-lamp-ok');
                            }
                        }
                    } else {
                        memPct.textContent = 'N/A';
                    }
                }

                updateMemory();
                setInterval(updateMemory, 3000);
            });
        </script>

    <!-- localStorage Usage Monitor -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const stBar = document.getElementById('storageProgressBar');
                const stPct = document.getElementById('storagePercent');
                const stLamp = document.getElementById('storageLamp');
                const LIMIT = 5 * 1024 * 1024; // 5 MB

                function updateStorage() {
                    let totalBytes = 0;
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        totalBytes += (key.length + localStorage.getItem(key).length) * 2; // UTF-16
                    }
                    const pct = Math.min(100, Math.round((totalBytes / LIMIT) * 100));
                    const usedMB = (totalBytes / (1024 * 1024)).toFixed(1);

                    if (stBar) {
                        stBar.style.width = pct + '%';
                        stBar.style.background = pct > 85 ? '#f56565' : pct > 60 ? '#f6ad55' : '#48bb78';
                    }
                    if (stPct) stPct.textContent = `${usedMB}MB`;
                    if (stLamp) {
                        stLamp.className = 'floating-lamp';
                        if (pct > 90) stLamp.classList.add('floating-lamp-error');
                        else if (pct > 70) stLamp.classList.add('floating-lamp-warning');
                        else stLamp.classList.add('floating-lamp-ok');
                    }
                }

                updateStorage();
                setInterval(updateStorage, 5000);
                // Update after fetch completes
                window.addEventListener('storage', updateStorage);
            });
        </script>

    <!-- Cache Bar Logic -->
    <script type="module">
        import { db2 } from './modules/database-v2.js';

        const cacheModules = [
            { table: 'poslowie', label: 'Pos≈Çowie', statKey: 'poslowie' },
            { table: 'posiedzenia', label: 'Posiedzenia', reqKey: 'sittings', statKey: 'posiedzenia' },
            { table: 'wypowiedzi', label: 'Wypowiedzi', reqKey: 'transcripts', statKey: 'wypowiedzi' },
            { table: 'glosowania', label: 'G≈Çosowania', reqKey: 'votings', statKey: 'glosowania' },
            { table: 'glosy', label: 'G≈Çosy', statKey: 'glosy' },
            { table: 'interpelacje', label: 'Interpelacje', reqKey: 'interpelacje', statKey: 'interpelacje' },
            { table: 'zapytania', label: 'Zapytania pisemne', reqKey: 'zapytania', statKey: 'zapytania' },
            { table: 'zapytania_odpowiedzi', label: 'Odpowiedzi na zapytania', statKey: 'zapytania_odpowiedzi' },
            { table: 'projekty_ustaw', label: 'Projekty ustaw', reqKey: 'projekty_ustaw', statKey: 'projekty_ustaw' },
            { table: 'ustawy', label: 'Ustawy (akty prawne)', reqKey: 'ustawy', statKey: 'ustawy' },
            { table: 'komisje', label: 'Komisje', statKey: 'komisje' },
            { table: 'komisje_posiedzenia', label: 'Posiedzenia komisji', statKey: 'komisje_posiedzenia' },
            { table: 'komisje_wypowiedzi', label: 'Wypowiedzi komisji', statKey: 'komisje_wypowiedzi' },
            { table: 'oswiadczenia_majatkowe', label: 'O≈õwiadczenia majƒÖtkowe', statKey: 'oswiadczenia_majatkowe' }
        ];

        function updateCacheBar() {
            const bar = document.getElementById('cacheBar');
            if (!bar) return;

            let expected = {};
            try {
                const lf = JSON.parse(localStorage.getItem('nostradamnos_lastFetch') || '{}');
                const req = lf.requestedCounts || {};
                const stats = lf.stats || {};
                for (const mod of cacheModules) {
                    const fromReq = mod.reqKey ? (req[mod.reqKey] || 0) : 0;
                    const fromStats = mod.statKey ? (stats[mod.statKey] || 0) : 0;
                    expected[mod.table] = Math.max(fromReq, fromStats);
                }
            } catch { /* ignore */ }

            bar.innerHTML = '';
            for (const mod of cacheModules) {
                const seg = document.createElement('div');
                seg.className = 'cache-segment';
                let count = 0;
                if (db2.database) {
                    try {
                        const r = db2.database.exec(`SELECT COUNT(*) FROM ${mod.table}`);
                        count = r[0]?.values[0]?.[0] || 0;
                    } catch { /* table may not exist */ }
                }
                const exp = expected[mod.table] || 0;
                if (count > 0 && exp > 0 && count >= exp) {
                    seg.classList.add('cached');
                    seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} (kompletne)`;
                } else if (count > 0) {
                    seg.classList.add('partial');
                    seg.title = exp > 0
                        ? `${mod.label}: ${count.toLocaleString('pl-PL')} / ${exp.toLocaleString('pl-PL')}`
                        : `${mod.label}: ${count.toLocaleString('pl-PL')}`;
                } else {
                    seg.title = `${mod.label}: puste`;
                }
                bar.appendChild(seg);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateCacheBar();
            setInterval(updateCacheBar, 5000);
        });
        window._updateCacheBar = updateCacheBar;
    </script>

    <!-- Bottom Navigation Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const navItems = document.querySelectorAll('.nav-item');
            const sections = document.querySelectorAll('.app-section');
            
            navItems.forEach(item => {
                item.addEventListener('click', () => {
                    const sectionNum = item.dataset.section;
                    
                    // Update nav active state
                    navItems.forEach(n => n.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Update sections
                    sections.forEach(s => {
                        s.style.display = 'none';
                        s.classList.remove('active');
                    });
                    
                    const targetSection = document.querySelector(`.app-section[data-section="${sectionNum}"]`);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                        targetSection.classList.add('active');
                    }

                    // Renderuj wykresy przy wej≈õciu na zak≈Çadkƒô 4
                    if (sectionNum === '4' && window._renderCharts) {
                        window._renderCharts();
                    }
                });
            });
        });
    </script>
    
    <!-- AI Chat Button - Navigate to configured section -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const aiChatBtn = document.getElementById('aiChatBtn');
            if (aiChatBtn) {
                aiChatBtn.addEventListener('click', () => {
                    let target = '3';
                    try {
                        const vis = JSON.parse(localStorage.getItem('uiVisibility') || '{}');
                        if (vis.btnAiTarget) target = vis.btnAiTarget;
                    } catch { /* default */ }
                    const nav = document.querySelector(`.nav-item[data-section="${target}"]`);
                    if (nav) nav.click();
                });
            }
        });
    </script>
    
    <!-- Floating Console Logic -->
    <script>
        const floatingPanel = document.getElementById('floatingConsolePanel');
        const closeBtn = document.getElementById('closeFloatingConsole');
        const consoleSection = document.getElementById('consoleSection');
        
        // Function to toggle console
        const toggleConsole = () => {
            const isVisible = getComputedStyle(floatingPanel).display !== 'none';
            floatingPanel.style.display = isVisible ? 'none' : 'block';
        };
        
        // Console section click (from floating bar)
        consoleSection?.addEventListener('click', toggleConsole);
        
        // Console keyboard shortcut: Ctrl+`
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === '`') {
                e.preventDefault();
                toggleConsole();
            }
        });
        
        closeBtn?.addEventListener('click', () => {
            floatingPanel.style.display = 'none';
        });
        
        // Simple sync function for logs (called by console interceptor)
        window.syncFloatingConsoleLogs = function() {
            const mainLogs = document.getElementById('apiLogs');
            const floatingLogs = document.getElementById('floatingConsoleLogs');
            if (mainLogs && floatingLogs) {
                floatingLogs.innerHTML = mainLogs.innerHTML;
                floatingLogs.scrollTop = floatingLogs.scrollHeight;
            }
        }
        
        // Initialize UI elements when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[DOMContentLoaded] Starting UI initialization');
            
            // Flush console buffer
            const apiLogs = document.getElementById('apiLogs');
            if (window.logBuffer.length > 0 && apiLogs) {
                apiLogs.innerHTML = '';
                
                window.logBuffer.forEach(entry => {
                    const line = document.createElement('div');
                    line.textContent = typeof entry === 'string' ? entry : entry.text;
                    line.style.fontSize = '0.85rem';
                    line.style.fontFamily = 'monospace';
                    line.style.lineHeight = '1.6';
                    const entryColor = (typeof entry === 'object' && entry.color) ? entry.color : null;
                    line.style.color = entryColor || LOG_COLORS.default;
                    if (!entryColor) line.setAttribute('data-default-color', '');
                    apiLogs.appendChild(line);
                });
                
                window.logBuffer = [];
                apiLogs.scrollTop = apiLogs.scrollHeight;
                window.syncFloatingConsoleLogs && window.syncFloatingConsoleLogs();
            }
            
            // Get all button elements
            const importDbBtn = document.getElementById('importDbBtn');
            const exportDbBtn = document.getElementById('exportDbBtn');
            const aboutBtn = document.getElementById('aboutBtn');
            const languageBtn = document.getElementById('languageBtn');
            const helpBtn = document.getElementById('helpBtn');
            
            console.log('[DOMContentLoaded] Elements found:',
                'importDbBtn:', !!importDbBtn,
                'exportDbBtn:', !!exportDbBtn,
                'aboutBtn:', !!aboutBtn,
                'languageBtn:', !!languageBtn,
                'helpBtn:', !!helpBtn
            );
            
            // Helper function to add button animation and click handler
            const addButtonAnimation = (btn, clickHandler) => {
                if (!btn) return;
                
                btn.addEventListener('mouseenter', () => {
                    btn.style.transform = 'scale(1.1)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'scale(1)';
                });
                btn.addEventListener('click', () => {
                    btn.style.transform = 'scale(0.9)';
                    setTimeout(() => btn.style.transform = 'scale(1)', 200);
                    clickHandler();
                });
            };
            
            // Attach button listeners with animation
            addButtonAnimation(aboutBtn, () => {
                ToastModule.info(
                    'Autor: Micha≈Ç Stankiewicz\n\n' +
                    'Osoby kt√≥re wspierajƒÖ: Robin070\n\n' +
                    'Pomoc w realizacji: Tomasz Gierczak, xBigle22x, szauw_iks',
                    { title: 'Parlament P.I.M.P. - Parliamentary Intelligence & Monitoring Platform', duration: 10000 }
                );
            });
            
            addButtonAnimation(languageBtn, () => {
                console.log('üáµüá± TODO: Zmiana jƒôzyka');
                ToastModule.info('Funkcja w przygotowaniu (TODO v5.0)', { title: 'üáµüá± Zmiana jƒôzyka' });
            });
            
            addButtonAnimation(helpBtn, () => {
                console.log('‚ùì TODO: Podpowiedzi');
                ToastModule.info('System podpowiedzi w przygotowaniu (TODO v5.0)', { title: '‚ùì Podpowiedzi' });
            });

            const resetMemoryBtn = document.getElementById('resetMemoryBtn');
            addButtonAnimation(resetMemoryBtn, () => {
                if (confirm('Czy na pewno chcesz zresetowaƒá pamiƒôƒá przeglƒÖdarki?\n\nTo usunie zapisane pozycje przycisk√≥w i ustawienia interfejsu.')) {
                    import('./modules/floating-drag.js').then(m => m.resetFloatingButtonPositions());
                    localStorage.removeItem('uiVisibility');
                    location.reload();
                }
            });

            // Summary import/export buttons ‚Üí proxy to floating buttons
            document.getElementById('summaryImportDb')?.addEventListener('click', () => {
                document.getElementById('importDbBtn')?.click();
            });
            document.getElementById('summaryExportDb')?.addEventListener('click', () => {
                document.getElementById('exportDbBtn')?.click();
            });

            // Language buttons (TODO)
            ['langPL', 'langEN', 'langUA'].forEach(id => {
                document.getElementById(id)?.addEventListener('click', () => {
                    ToastModule.info('Funkcja w przygotowaniu (TODO v5.0)', { title: 'üáµüá± Zmiana jƒôzyka' });
                });
            });

            console.log('[DOMContentLoaded] Initialization complete');
        });
    </script>
    <script type="module">
        import { initDbButtons } from './modules/db-buttons.js';
        initDbButtons();
    </script>
    <script type="module">
        import { renderAllCharts } from './modules/charts.js';
        window._renderCharts = renderAllCharts;
    </script>

    <script type="module">
        import { initAIChat } from './modules/ai-chat.js';

        // Initialize AI Chat after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAIChat);
        } else {
            initAIChat();
        }
    </script>

    <!-- Top Info Bar ‚Äî scrolling help messages -->
    <script>
    (function() {
        const messages = [
            '≈öciƒÖgnij dane do analizy w zak≈Çadce ETL ‚Äî zaznacz interesujƒÖce Ciƒô dane oraz kliknij przycisk "Pobierz dane"',
            'Porozmawiaj z asystentem AI, aby uzyskaƒá analizƒô pobranych danych parlamentarnych',
            'Sprawd≈∫ statystyki g≈Çosowa≈Ñ i frekwencjƒô pos≈Ç√≥w w zak≈Çadce Analiza',
            'Por√≥wnaj wypowiedzi pos≈Ç√≥w na wybrany temat za pomocƒÖ narzƒôdzia por√≥wnania',
            'Dostosuj wyglƒÖd aplikacji w zak≈Çadce Ustawienia ‚Äî wybierz styl Jasny, Ciemny lub Retro'
        ];

        const textEl = document.getElementById('topInfoText');
        if (!textEl) return;

        let idx = 0;

        function showNext() {
            textEl.classList.add('reset');
            textEl.textContent = messages[idx];
            void textEl.offsetWidth;
            textEl.classList.remove('reset');
            idx = (idx + 1) % messages.length;
        }

        textEl.addEventListener('animationend', function() {
            setTimeout(showNext, 3000);
        });

        showNext();
    })();
    </script>

    <!-- Settings: UI visibility toggles -->
    <script>
    (function() {
        const STORAGE_KEY = 'uiVisibility';

        const defaults = {
            floatingBtns: true,
            topBar: true,
            bottomBar: true,
            btnImport: true,
            btnExport: true,
            btnAi: true,
            btnAiTarget: '3',
            btnAbout: true,
            btnHelp: true,
            btnLanguage: false,
            btnReset: false,
            barVersion: true,
            barDb: true,
            barAi: true,
            barLoad: true,
            barMemory: false,
            barStorage: false,
            barCache: true,
            barConsole: true
        };

        function load() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                return saved ? { ...defaults, ...JSON.parse(saved) } : { ...defaults };
            } catch { return { ...defaults }; }
        }

        function save(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function apply(state) {
            // Floating buttons ‚Äî delegate to UI mode manager (handles master toggle + per-button)
            if (typeof window._updateUIMode === 'function') {
                window._updateUIMode();
            }

            // Top info bar
            const topBar = document.getElementById('topInfoBar');
            if (topBar) topBar.style.display = state.topBar ? '' : 'none';
            document.body.style.paddingTop = state.topBar ? '27px' : '0';

            // Bottom floating status bar
            const bottomBar = document.getElementById('floatingStatusBar');
            if (bottomBar) bottomBar.style.display = state.bottomBar ? '' : 'none';
            document.body.style.paddingBottom = state.bottomBar ? '25px' : '0';

            // Individual bar sections
            const barSections = [
                { key: 'barVersion', id: 'versionSection' },
                { key: 'barDb', id: 'statusIndicators' },
                { key: 'barAi', id: 'aiStatusSection' },
                { key: 'barLoad', id: 'etlProgressSection' },
                { key: 'barMemory', id: 'memorySection' },
                { key: 'barStorage', id: 'storageSection' },
                { key: 'barCache', id: 'cacheSection' },
                { key: 'barConsole', id: 'consoleSection' }
            ];
            for (const { key, id } of barSections) {
                const el = document.getElementById(id);
                if (!el) continue;
                el.style.display = state[key] ? '' : 'none';
                const prev = el.previousElementSibling;
                if (prev && prev.classList.contains('status-bar-separator')) {
                    prev.style.display = state[key] ? '' : 'none';
                }
            }
        }

        const state = load();

        const chkBtns = document.getElementById('toggleFloatingBtns');
        const chkTop = document.getElementById('toggleTopBar');
        const chkBottom = document.getElementById('toggleBottomBar');

        if (chkBtns) chkBtns.checked = state.floatingBtns;
        if (chkTop) chkTop.checked = state.topBar;
        if (chkBottom) chkBottom.checked = state.bottomBar;

        // Per-button checkboxes
        const btnToggles = [
            { key: 'btnImport', id: 'toggleBtnImport' },
            { key: 'btnExport', id: 'toggleBtnExport' },
            { key: 'btnAi', id: 'toggleBtnAi' },
            { key: 'btnAbout', id: 'toggleBtnAbout' },
            { key: 'btnHelp', id: 'toggleBtnHelp' },
            { key: 'btnLanguage', id: 'toggleBtnLanguage' },
            { key: 'btnReset', id: 'toggleBtnReset' }
        ];
        for (const { key, id } of btnToggles) {
            const chk = document.getElementById(id);
            if (chk) chk.checked = !!state[key];
        }

        // AI button target select + icon sync
        const sectionIcons = { '1': 'üì•', '2': 'üìä', '3': 'ü§ñ', '4': 'üìà', '5': '‚öôÔ∏è' };
        const aiTargetSelect = document.getElementById('btnAiTargetSelect');
        const aiBtn = document.getElementById('aiChatBtn');
        function updateAiBtnIcon(target) {
            if (aiBtn && sectionIcons[target]) aiBtn.textContent = sectionIcons[target];
        }
        if (aiTargetSelect) {
            const savedTarget = state.btnAiTarget || '3';
            aiTargetSelect.value = savedTarget;
            updateAiBtnIcon(savedTarget);
            aiTargetSelect.addEventListener('change', function() {
                state.btnAiTarget = this.value;
                save(state);
                updateAiBtnIcon(this.value);
            });
        }

        // Bar section checkboxes
        const barToggles = [
            { key: 'barVersion', id: 'toggleBarVersion' },
            { key: 'barDb', id: 'toggleBarDb' },
            { key: 'barAi', id: 'toggleBarAi' },
            { key: 'barLoad', id: 'toggleBarLoad' },
            { key: 'barMemory', id: 'toggleBarMemory' },
            { key: 'barStorage', id: 'toggleBarStorage' },
            { key: 'barCache', id: 'toggleBarCache' },
            { key: 'barConsole', id: 'toggleBarConsole' }
        ];
        for (const { key, id } of barToggles) {
            const chk = document.getElementById(id);
            if (chk) chk.checked = !!state[key];
        }

        apply(state);

        function onToggle(key, checkbox) {
            if (!checkbox) return;
            checkbox.addEventListener('change', function() {
                state[key] = this.checked;
                save(state);
                apply(state);
            });
        }

        onToggle('floatingBtns', chkBtns);
        onToggle('topBar', chkTop);
        onToggle('bottomBar', chkBottom);
        for (const { key, id } of btnToggles) {
            onToggle(key, document.getElementById(id));
        }
        for (const { key, id } of barToggles) {
            onToggle(key, document.getElementById(id));
        }
    })();
    </script>
</body>
</html>
