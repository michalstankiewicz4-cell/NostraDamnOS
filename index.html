<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIMP¬© Polityczny Informator, Model Predykcyjny</title>
    <link rel="icon" href="data:,">
    <meta name="author" content="Micha≈Ç Stankiewicz">
    <meta name="description" content="PIMP - System lokalnej analizy wypowiedzi parlamentarnych z API Sejmu RP. Autor: Micha≈Ç Stankiewicz. Wsp√≥≈Çtw√≥rcy: Claude Sonnet 4.5, GitHub Copilot">
    <link rel="stylesheet" href="style.css">

    <!-- ‚úÖ GOOGLE ANALYTICS 4 + Google Ads + Consent Mode v2 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VZ3BMQQENE"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('consent', 'default', {
            analytics_storage: localStorage.getItem('analytics_consent') === 'granted' ? 'granted' : 'denied'
        });
        gtag('js', new Date());
        gtag('config', 'G-VZ3BMQQENE');
        gtag('config', 'AW-17951379469');
    </script>
    
    <!-- ‚úÖ GEOLOKALIZACJA - AKTYWNA -->
    <script type="module">
        import { enforceEuropeOnly } from "./modules/geo.js";
        import { initConsent } from "./modules/consent.js";
        import "./modules/analytics.js";
        enforceEuropeOnly();
        initConsent();
    </script>
</head>
<body>
    <!-- Project Metadata -->
    <script>
        window.PROJECT = {
            name: "PIMP \"puppy\"",
            version: "4.0.0",
            author: "Micha≈Ç Stankiewicz",
            contributors: "Claude Sonnet 4.5, GitHub Copilot",
            repository: "https://github.com/michalstankiewicz4-cell/NostraDamnOS"
        };

        function logProjectInfo() {
            console.log(`%c${window.PROJECT.name} v${window.PROJECT.version}`, 'font-weight: bold; font-size: 14px; color: #667eea;');
            console.log(`%cAutor: ${window.PROJECT.author} | Wsp√≥≈Çtw√≥rcy: ${window.PROJECT.contributors}`, 'font-size: 12px; color: #718096;');
        }

        async function loadProjectMetadata() {
            try {
                const response = await fetch('./project.json', { cache: 'no-store' });
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                if (data?.name) window.PROJECT.name = data.name;
                if (data?.version) window.PROJECT.version = data.version;
                if (data?.author?.name) window.PROJECT.author = data.author.name;
                if (data?.contributors) window.PROJECT.contributors = data.contributors;

                document.title = `${window.PROJECT.name} v${window.PROJECT.version}`;

                const headerTitle = document.querySelector('header h1');
                if (headerTitle) headerTitle.textContent = `üèõÔ∏è ${window.PROJECT.name}`;

                const versionEl = document.getElementById('projectVersion');
                if (versionEl) versionEl.textContent = `v${window.PROJECT.version}`;

                const programVersionEl = document.getElementById('programVersion');
                if (programVersionEl) programVersionEl.textContent = window.PROJECT.version;
                
            } catch (error) {
                console.warn('Nie uda≈Ço siƒô wczytaƒá project.json:', error);
            } finally {
                logProjectInfo();
            }
        }

        document.addEventListener('DOMContentLoaded', loadProjectMetadata);
    </script>
    
    <!-- Console Log Interceptor - catches ALL logs and redirects to floating console -->
    <script>
        // Buffer for early logs (before UI console exists)
        window.logBuffer = [];
        window.originalConsoleLog = console.log;

        // Log level colors (default adapts to console style)
        const LOG_COLORS = {
            default: '#1a202c',
            red:     '#f56565',
            green:   '#48bb78',
            yellow:  '#ecc94b',
            blue:    '#63b3ed'
        };

        // Map console style ‚Üí default log text color
        const STYLE_DEFAULT_COLORS = {
            'console-modern': '#1a202c'
        };

        // Called by style switcher to update default log color
        window.updateLogDefaultColor = function(styleClass) {
            const newColor = STYLE_DEFAULT_COLORS[styleClass] || '#1a202c';
            LOG_COLORS.default = newColor;

            // Recolor existing default-colored log lines (marked with data-default-color)
            const apiLogs = document.getElementById('apiLogs');
            if (apiLogs) {
                apiLogs.querySelectorAll('div[data-default-color]').forEach(line => {
                    line.style.color = newColor;
                });
                window.syncFloatingConsoleLogs && window.syncFloatingConsoleLogs();
            }
        };

        // Console lamp: blink on error/warn/info, reset when console opened
        function updateConsoleLamp(color) {
            const lamp = document.getElementById('consoleLamp');
            if (!lamp) return;
            const panel = document.getElementById('floatingConsolePanel');
            if (panel && getComputedStyle(panel).display !== 'none') return;

            if (color === LOG_COLORS.red) {
                lamp.className = 'floating-lamp floating-lamp-error floating-lamp-blink';
            } else if (color === LOG_COLORS.yellow) {
                lamp.className = 'floating-lamp floating-lamp-warn floating-lamp-blink';
            } else if (color === LOG_COLORS.blue) {
                lamp.className = 'floating-lamp floating-lamp-info floating-lamp-blink';
            }
        }

        // Core logging function with color support
        function addLogLine(message, color) {
            const timestamp = new Date().toLocaleTimeString();
            const formattedLog = `[${timestamp}] ${message}`;
            const apiLogs = document.getElementById('apiLogs');

            updateConsoleLamp(color);

            const isDefault = !color || color === LOG_COLORS.default;

            if (apiLogs) {
                const line = document.createElement('div');
                line.textContent = formattedLog;
                line.style.fontSize = '0.85rem';
                line.style.fontFamily = 'monospace';
                line.style.lineHeight = '1.6';
                line.style.color = isDefault ? LOG_COLORS.default : color;
                if (isDefault) line.setAttribute('data-default-color', '');
                apiLogs.appendChild(line);
                apiLogs.scrollTop = apiLogs.scrollHeight;
                window.syncFloatingConsoleLogs && window.syncFloatingConsoleLogs();
            } else {
                window.logBuffer.push({ text: formattedLog, color: isDefault ? null : color });
            }
        }

        // Format args to string
        function formatArgs(args) {
            return args.map(arg => {
                if (typeof arg === 'object') {
                    try { return JSON.stringify(arg, null, 2); } catch { return String(arg); }
                }
                return String(arg);
            }).join(' ');
        }

        // Override console.log ‚Üí default color
        console.log = function(...args) {
            window.originalConsoleLog.apply(console, args);
            addLogLine(formatArgs(args), LOG_COLORS.default);
        };

        // Override console.error ‚Üí red
        const originalConsoleError = console.error;
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addLogLine(formatArgs(args), LOG_COLORS.red);
        };

        // clog(level, ...args) ‚Äî colored console log
        // Levels: 'red' (error), 'green' (ok), 'yellow' (info), 'blue' (sql), 'default' (normal)
        window.clog = function(level, ...args) {
            const color = LOG_COLORS[level] || LOG_COLORS.default;
            window.originalConsoleLog.apply(console, [`[${level.toUpperCase()}]`, ...args]);
            addLogLine(formatArgs(args), color);
        };
    </script>
    
    <div class="container">
        <header>
            <h1>üèõÔ∏è Parlament P.I.M.P.</h1>
            <p>System lokalnej analizy wypowiedzi parlamentarnych | <span id="projectVersion">v4.0.0</span></p>
        </header>

        <!-- Top Info Bar -->
        <div id="topInfoBar" class="top-info-bar"
            data-help-id="topInfoBar">
            <span id="topInfoText" class="top-info-text"></span>
        </div>



        <!-- MAIN - 4 SEKCJE Z NAWIGACJƒÑ -->
        <main class="app-sections-container">

            <!-- SEKCJA 1: FORMULARZ ETL -->
            <section class="app-section active" data-section="1">

                <!-- Powiadomienie: zasada pracy na danych -->
                <div id="dataWorkflowOverlay" class="wip-overlay hidden">
                    <div class="wip-modal">
                        <div class="wip-icon">üí°</div>
                        <h3 class="wip-title">Zasada pracy na danych</h3>
                        <p class="wip-text">Pamiƒôtaj o zasadzie pracy na danych:<br><strong>≈öciƒÖgnij raz, wyeksportuj a potem analizuj</strong><br>aby niepotrzebnie ponownie nie pobieraƒá.</p>
                        <button id="dataWorkflowCloseBtn" class="wip-close-btn">Rozumiem</button>
                    </div>
                </div>
                
                <div class="etl-panel">
                    <div class="etl-sidebar">
                        <h3>üìä Konfiguracja ETL</h3>
                        
                        <div class="summary-item">
                            <strong>Instytucja:</strong>
                            <span id="etlInstitution">Sejm</span>
                        </div>
                        
                        <div class="summary-item">
                            <strong>Kadencja:</strong>
                            <span id="etlTerm">10</span>
                        </div>
                        
                        <div class="summary-item">
                            <strong>Zakres:</strong>
                            <span id="etlRange">3 posiedzenia (1-3)</span>
                        </div>
                        
                        <div class="summary-item etl-summary-column">
                            <strong>Dane:</strong>
                            <div class="summary-data-list" id="etlData">wypowiedzi</div>
                        </div>
                        
                        <div class="estimate-box"
                            data-help-id="estimateBox">
                            <div class="estimate-title">üí° Estymacja</div>
                            <div class="estimate-grid">
                                <div class="estimate-row estimate-row-size">
                                    <span class="estimate-label">Rozmiar:</span>
                                    <span class="estimate-value" id="etlSize">~700 KB</span>
                                </div>
                                <div class="estimate-row estimate-row-time">
                                    <span class="estimate-label">Czas:</span>
                                    <span class="estimate-value" id="etlTime">~10-15s</span>
                                </div>
                                <div class="estimate-row estimate-row-last estimate-row-requests">
                                    <span class="estimate-label">Requesty:</span>
                                    <span class="estimate-value" id="etlRequests">~25</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="etl-rodo-box">
                            <label class="etl-rodo-label">
                                <input type="checkbox" id="etlRodoFilter" checked disabled>
                                <span class="etl-rodo-span">üîí Filtr RODO (zawsze aktywny)</span>
                            </label>
                            <div class="etl-rodo-description">
                                ‚úì Usuwa dane wra≈ºliwe: email, telefon, PESEL
                            </div>
                        </div>
                        
                        <button class="etl-btn etl-btn-primary" id="etlFetchBtn"
                            data-help-id="etlFetchBtn">
                            üì• Pobierz/Zaktualizuj dane
                        </button>
                        
                        <button class="etl-btn etl-btn-danger" id="etlClearBtn"
                            data-help-id="etlClearBtn">
                            üóëÔ∏è Wyczy≈õƒá bazƒô
                        </button>
                    </div>
                    
                    <div class="etl-main">
                        <!-- Instytucja -->
                        <fieldset class="etl-fieldset"
                            data-help-id="fieldInstitution">
                            <legend>üèõÔ∏è Instytucja</legend>
                            <div class="etl-radio-group">
                                <label class="etl-radio-option">
                                    <input type="radio" name="etlInst" value="sejm" checked> Sejm <span id="etlTermCountSejm" class="term-count"></span>
                                </label>
                                <label class="etl-radio-option">
                                    <input type="radio" name="etlInst" value="rss"> RSS.gov üì∞
                                </label>
                                <label class="etl-radio-option" style="opacity: 0.5; cursor: not-allowed;">
                                    <input type="radio" name="etlInst" value="senat" disabled> Senat <span id="etlTermCountSenat" class="term-count"></span>
                                </label>
                                <label class="etl-radio-option" style="opacity: 0.5; cursor: not-allowed;">
                                    <input type="radio" name="etlInst" value="minfin" disabled> Min. Fin. üí∞
                                </label>
                                <label class="etl-radio-option" style="opacity: 0.5; cursor: not-allowed;">
                                    <input type="radio" name="etlInst" value="internet" disabled> Internet API üåê
                                </label>
                            </div>
                            <div class="etl-internet-api-box" style="margin-top: 8px; opacity: 0.45; pointer-events: none;">
                                <select class="form-control etl-select-margin" id="etlInternetSource" disabled>
                                    <option value="" disabled selected>‚Äî Wybierz ≈∫r√≥d≈Ço ‚Äî</option>
                                    <optgroup label="üì∞ Gazety / Portale">
                                        <option value="onet">Onet.pl ‚Äî Wiadomo≈õci</option>
                                        <option value="wp">Wirtualna Polska (WP)</option>
                                        <option value="interia">Interia Fakty</option>
                                        <option value="gazeta">Gazeta.pl</option>
                                        <option value="tvn24">TVN24.pl</option>
                                        <option value="polsat">Polsat News</option>
                                        <option value="rp">Rzeczpospolita</option>
                                        <option value="wyborcza">Gazeta Wyborcza</option>
                                        <option value="dorzeczy">Do Rzeczy</option>
                                        <option value="wpolityce">wPolityce.pl</option>
                                        <option value="niezalezna">Niezale≈ºna.pl</option>
                                        <option value="oko">OKO.press</option>
                                    </optgroup>
                                    <optgroup label="üì° Agencje prasowe">
                                        <option value="pap">PAP ‚Äî Polska Agencja Prasowa</option>
                                        <option value="isa">ISBnews / ISBtech</option>
                                    </optgroup>
                                    <optgroup label="üèõÔ∏è Instytucje">
                                        <option value="prezydent">Prezydent.pl</option>
                                        <option value="premier">Gov.pl ‚Äî Premier</option>
                                        <option value="nik">NIK ‚Äî Najwy≈ºsza Izba Kontroli</option>
                                        <option value="rpo">RPO ‚Äî Rzecznik Praw Obywatelskich</option>
                                    </optgroup>
                                </select>
                                <div class="etl-section-hint" style="margin-top: 4px;">üîú Wkr√≥tce ‚Äî analiza online</div>
                            </div>
                        </fieldset>
                        
                        <!-- RSS Feeds Panel (hidden by default) -->
                        <fieldset class="etl-fieldset" id="rssPanel" style="display:none;">
                            <legend>üì∞ ≈πr√≥d≈Ça RSS gov.pl</legend>
                            <div class="etl-section-hint">Wybierz kana≈Çy RSS do pobrania</div>
                            <div style="margin-bottom:6px;">
                                <button type="button" class="etl-btn" id="rssSelectAll" style="font-size:0.8rem;padding:2px 8px;margin-right:4px;">‚úÖ Zaznacz wszystkie</button>
                                <button type="button" class="etl-btn" id="rssDeselectAll" style="font-size:0.8rem;padding:2px 8px;">‚ùå Odznacz wszystkie</button>
                            </div>

                            <div class="etl-section-hint" style="margin-top:8px;font-weight:600;">üèõÔ∏è Ministerstwa</div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_premier" data-rss-url="https://www.gov.pl/web/premier/aktualnosci"><label for="rssFeed_premier">Kancelaria Prezesa Rady Ministr√≥w</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_finanse" data-rss-url="https://www.gov.pl/web/finanse/aktualnosci"><label for="rssFeed_finanse">Ministerstwo Finans√≥w</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_zdrowie" data-rss-url="https://www.gov.pl/web/zdrowie/wiadomosci"><label for="rssFeed_zdrowie">Ministerstwo Zdrowia</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_edukacja" data-rss-url="https://www.gov.pl/web/edukacja/aktualnosci"><label for="rssFeed_edukacja">Ministerstwo Edukacji</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_mswia" data-rss-url="https://www.gov.pl/web/mswia/aktualnosci"><label for="rssFeed_mswia">Ministerstwo Spraw Wewnƒôtrznych i Administracji</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_dyplomacja" data-rss-url="https://www.gov.pl/web/dyplomacja/aktualnosci"><label for="rssFeed_dyplomacja">Ministerstwo Spraw Zagranicznych</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_mon" data-rss-url="https://www.gov.pl/web/obrona-narodowa/aktualnosci5"><label for="rssFeed_mon">Ministerstwo Obrony Narodowej</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_cyfryzacja" data-rss-url="https://www.gov.pl/web/cyfryzacja/aktualnosci"><label for="rssFeed_cyfryzacja">Ministerstwo Cyfryzacji</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_klimat" data-rss-url="https://www.gov.pl/web/klimat/aktualnosci"><label for="rssFeed_klimat">Ministerstwo Klimatu i ≈örodowiska</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_infrastruktura" data-rss-url="https://www.gov.pl/web/infrastruktura/aktualnosci"><label for="rssFeed_infrastruktura">Ministerstwo Infrastruktury</label></div>

                            <div class="etl-section-hint" style="margin-top:8px;font-weight:600;">üè¢ Instytucje publiczne <span style="font-weight:400;font-size:0.8rem;color:#a0aec0;">(wkr√≥tce)</span></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_nbp" data-rss-url="https://nbp.pl/feed/" data-site-url="https://nbp.pl/kategoria/aktualnosci/" disabled><label for="rssFeed_nbp">NBP ‚Äì Narodowy Bank Polski</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_uokik" data-rss-url="https://uokik.gov.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_uokik">UOKiK</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_rpo" data-rss-url="https://bip.brpo.gov.pl/rss.xml" disabled><label for="rssFeed_rpo">Rzecznik Praw Obywatelskich</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_gus" data-rss-url="https://stat.gov.pl/rss/komunikaty.xml" disabled><label for="rssFeed_gus">GUS ‚Äì G≈Ç√≥wny UrzƒÖd Statystyczny</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_zus" data-rss-url="https://www.zus.pl/rss" disabled><label for="rssFeed_zus">ZUS ‚Äì Zak≈Çad Ubezpiecze≈Ñ Spo≈Çecznych</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_cert" data-rss-url="https://cert.pl/feed/" disabled><label for="rssFeed_cert">CERT Polska (NASK)</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_policja" data-rss-url="https://policja.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_policja">Policja</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_sg" data-rss-url="https://strazgraniczna.pl/pl/rss/aktualnosci/1/rss.xml" disabled><label for="rssFeed_sg">Stra≈º Graniczna</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_psp" data-rss-url="https://www.gov.pl/web/kgpsp/aktualnosci" disabled><label for="rssFeed_psp">Pa≈Ñstwowa Stra≈º Po≈ºarna</label></div>

                            <div class="etl-section-hint" style="margin-top:8px;font-weight:600;">üó∫Ô∏è Wojew√≥dztwa <span style="font-weight:400;font-size:0.8rem;color:#a0aec0;">(wkr√≥tce)</span></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_dolnoslaskie" data-rss-url="https://www.duw.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_dolnoslaskie">Wojew√≥dztwo Dolno≈õlƒÖskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_kujpom" data-rss-url="https://www.kujawsko-pomorskie.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_kujpom">Wojew√≥dztwo Kujawsko-Pomorskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_lubelskie" data-rss-url="https://www.lubelskie.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_lubelskie">Wojew√≥dztwo Lubelskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_lubuskie" data-rss-url="https://lubuskie.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_lubuskie">Wojew√≥dztwo Lubuskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_lodzkie" data-rss-url="https://www.lodzkie.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_lodzkie">Wojew√≥dztwo ≈Å√≥dzkie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_malopolskie" data-rss-url="https://www.malopolska.pl/rss" disabled><label for="rssFeed_malopolskie">Wojew√≥dztwo Ma≈Çopolskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_mazowieckie" data-rss-url="https://www.mazovia.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_mazowieckie">Wojew√≥dztwo Mazowieckie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_opolskie" data-rss-url="https://www.opolskie.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_opolskie">Wojew√≥dztwo Opolskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_podkarpackie" data-rss-url="https://podkarpackie.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_podkarpackie">Wojew√≥dztwo Podkarpackie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_podlaskie" data-rss-url="https://www.wrotapodlasia.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_podlaskie">Wojew√≥dztwo Podlaskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_pomorskie" data-rss-url="https://pomorskie.eu/rss/aktualnosci.xml" disabled><label for="rssFeed_pomorskie">Wojew√≥dztwo Pomorskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_slaskie" data-rss-url="https://www.slaskie.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_slaskie">Wojew√≥dztwo ≈ölƒÖskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_swietokrzyskie" data-rss-url="https://www.swietokrzyskie.pro/rss/aktualnosci.xml" disabled><label for="rssFeed_swietokrzyskie">Wojew√≥dztwo ≈öwiƒôtokrzyskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_warminsko" data-rss-url="https://warmia.mazury.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_warminsko">Wojew√≥dztwo Warmi≈Ñsko-Mazurskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_wielkopolskie" data-rss-url="https://www.umww.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_wielkopolskie">Wojew√≥dztwo Wielkopolskie</label></div>
                            <div class="checkbox-item"><input type="checkbox" id="rssFeed_zachodniopom" data-rss-url="https://www.wzp.pl/rss/aktualnosci.xml" disabled><label for="rssFeed_zachodniopom">Wojew√≥dztwo Zachodniopomorskie</label></div>
                        </fieldset>

                        <!-- Kadencja -->
                        <fieldset class="etl-fieldset" id="etlFieldTerm"
                            data-help-id="fieldTerm">
                            <legend>üìÖ Kadencja</legend>
                            <select id="etlTermSelect" class="form-control">
                                <option value="10">10. kadencja (2023-obecnie)</option>
                                <option value="9">9. kadencja (2019-2023)</option>
                                <option value="8">8. kadencja (2015-2019)</option>
                                <option value="7">7. kadencja (2011-2015)</option>
                            </select>
                            <span id="etlSittingsCount" class="term-count"></span>
                        </fieldset>
                        
                        <!-- Zakres posiedze≈Ñ -->
                        <fieldset class="etl-fieldset" id="etlFieldRange"
                            data-help-id="fieldRange">
                            <legend>üéØ Zakres posiedze≈Ñ</legend>
                            <div class="etl-input-group">
                                <span id="etlRangeFromLabel" class="etl-input-label">od</span>
                                <input type="number" id="etlRangeFrom" value="1" min="1" class="etl-number-input">
                                <span id="etlRangeToLabel" class="etl-input-label">do:</span>
                                <input type="number" id="etlRangeTo" value="3" min="1" class="etl-number-input">
                            </div>
                        </fieldset>
                        
                        <!-- Dane podstawowe -->
                        <fieldset class="etl-fieldset etl-sejm-fieldset"
                            data-help-id="fieldBasicData">
                            <legend>üìã Dane podstawowe</legend>
                            <div class="etl-section-hint">Zawsze pobierane</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlDeputies" checked disabled>
                                <label for="etlDeputies">Pos≈Çowie/Senatorowie</label>
                                <span class="badge badge-size">50 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlSittings" checked disabled>
                                <label for="etlSittings">Posiedzenia (lista)</label>
                                <span class="badge badge-size">20 KB</span>
                            </div>
                        </fieldset>
                        
                        <!-- Dane per posiedzenie -->
                        <fieldset class="etl-fieldset etl-sejm-fieldset"
                            data-help-id="fieldPerSitting">
                            <legend>üìù Dane per posiedzenie</legend>
                            <div class="etl-section-hint">Incremental (per posiedzenie)</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlTranscripts" data-size="400" checked>
                                <label for="etlTranscripts">Wypowiedzi</label>
                                <span id="etlTranscriptsCount" class="term-count"></span>
                                <span class="badge badge-size">400 KB/pos.</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlVotings" data-size="15">
                                <label for="etlVotings">G≈Çosowania</label>
                                <span id="etlVotingsCount" class="term-count"></span>
                                <span class="badge badge-size">15 KB/pos.</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlVotes" data-size="1200">
                                <label for="etlVotes">G≈Çosy indywidualne <small style="color:var(--text-secondary)">(zliczane, nie pobierane)</small></label>
                                <span id="etlVotesCount" class="term-count"></span>
                                <span class="badge badge-size">1.2 MB/pos.</span>
                            </div>
                        </fieldset>
                        
                        <!-- Dane per kadencja -->
                        <fieldset class="etl-fieldset etl-sejm-fieldset"
                            data-help-id="fieldPerTerm">
                            <legend>üóÇÔ∏è Dane per kadencja</legend>
                            <div class="etl-section-hint">Ca≈Ça kadencja (du≈ºe!)</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlInterpellations" data-size="4000">
                                <label for="etlInterpellations">Interpelacje</label>
                                <span id="etlInterpellationsCount" class="term-count"></span>
                                <span class="badge badge-size">~4 MB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlWrittenQuestions" data-size="800">
                                <label for="etlWrittenQuestions">Zapytania pisemne</label>
                                <span id="etlWrittenQuestionsCount" class="term-count"></span>
                                <span class="badge badge-size">~800 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlBills" data-size="700">
                                <label for="etlBills">Projekty ustaw</label>
                                <span id="etlBillsCount" class="term-count"></span>
                                <span class="badge badge-size">~700 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlLegalActs" data-size="500">
                                <label for="etlLegalActs">Ustawy (akty prawne)</label>
                                <span id="etlLegalActsCount" class="term-count"></span>
                                <span class="badge badge-size">~500 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlDisclosures" data-size="500" disabled>
                                <label style="opacity:0.4; pointer-events:none;">O≈õwiadczenia majƒÖtkowe <small>(API niedostƒôpne)</small></label>
                            </div>
                        </fieldset>
                        
                        <!-- Komisje -->
                        <fieldset class="etl-fieldset etl-sejm-fieldset"
                            data-help-id="fieldCommittees">
                            <legend>üè¢ Komisje</legend>
                            <div class="etl-section-hint">Wybierz dane komisji</div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlCommitteeSittings" data-size="80">
                                <label for="etlCommitteeSittings">Posiedzenia komisji</label>
                                <span id="etlCommitteeSittingsCount" class="term-count"></span>
                                <span class="badge badge-size">80 KB</span>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="etlCommitteeStatements" data-size="200" disabled>
                                <label style="opacity:0.4; pointer-events:none;">Wypowiedzi komisji <small>(API niedostƒôpne)</small></label>
                            </div>
                            
                            <div class="etl-fieldset-margin">
                                <label class="etl-checkbox-label">
                                    üìã Wybierz komisje:
                                </label>
                                <select id="etlCommitteeSelect" class="form-control etl-committee-select" multiple size="8">
                                    <option value="all" selected>‚úì Wszystkie komisje</option>
                                </select>
                            </div>
                        </fieldset>
                    </div>
                </div>

                <!-- Hidden Progress & Logs (for floating console) -->
                <div id="apiProgress" style="display:none;">
                    <div class="api-progress-bar-wrapper">
                        <div id="apiProgressBar" class="api-progress-bar"></div>
                    </div>
                    <div id="apiProgressText" class="api-progress-text">Postƒôp: 0%</div>
                    <div id="apiLogs" class="api-logs"></div>
                </div>
                
                <!-- Status -->
                <div id="apiStatus" class="api-status-box">
                    <div class="api-status-title">‚úÖ Status bazy:</div>
                    <div id="apiStatusDetails" class="api-status-details">Baza pusta - pobierz dane</div>
                </div>
            </section>

            <!-- SEKCJA 2: PODSUMOWANIE DANYCH -->
            <section class="app-section" data-section="2" style="display:none;">

                <!-- Panel: Zlecone vs Pobrane -->
                <div id="fetchOverview" class="fetch-overview" style="display:none;">
                    <div class="fetch-overview-col">
                        <h4>Zlecone</h4>
                        <table class="fetch-overview-table">
                            <tbody>
                                <tr><td>Instytucja</td><td id="fovInst">‚Äî</td></tr>
                                <tr><td>Kadencja</td><td id="fovKadencja">‚Äî</td></tr>
                                <tr><td>Zakres posiedze≈Ñ</td><td id="fovRange">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane podstawowe</td></tr>
                                <tr><td>Pos≈Çowie</td><td id="fovReqDeputies">‚Äî</td></tr>
                                <tr><td>Posiedzenia</td><td id="fovReqSittings">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per posiedzenie</td></tr>
                                <tr><td>Dni obrad</td><td id="fovReqSessionDays">‚Äî</td></tr>
                                <tr><td>Wypowiedzi</td><td id="fovReqTranscripts">‚Äî</td></tr>
                                <tr><td>G≈Çosowania</td><td id="fovReqVotings">‚Äî</td></tr>
                                <tr><td>G≈Çosy indywidualne</td><td id="fovReqVotes">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per kadencja</td></tr>
                                <tr><td>Interpelacje</td><td id="fovReqInterpellations">‚Äî</td></tr>
                                <tr><td>Zapytania pisemne</td><td id="fovReqQuestions">‚Äî</td></tr>
                                <tr><td>Projekty ustaw</td><td id="fovReqBills">‚Äî</td></tr>
                                <tr><td>Ustawy</td><td id="fovReqActs">‚Äî</td></tr>
                                <tr><td>O≈õwiadczenia</td><td id="fovReqDisclosures">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Komisje</td></tr>
                                <tr><td>Komisje</td><td id="fovReqCommittees">‚Äî</td></tr>
                                <tr><td>Posiedzenia komisji</td><td id="fovReqCommitteeSittings">‚Äî</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="fetch-overview-col">
                        <h4>Pobrane / Importowane</h4>
                        <table class="fetch-overview-table">
                            <tbody>
                                <tr><td>Instytucja</td><td id="fovGotInst">‚Äî</td></tr>
                                <tr><td>Kadencja</td><td id="fovGotKadencja">‚Äî</td></tr>
                                <tr><td>Posiedzenia w zakresie</td><td id="fovGotRange">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane podstawowe</td></tr>
                                <tr><td>Pos≈Çowie</td><td id="fovGotDeputies">‚Äî</td></tr>
                                <tr><td>Posiedzenia</td><td id="fovGotSittings">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per posiedzenie</td></tr>
                                <tr><td>Dni obrad</td><td id="fovGotSessionDays">‚Äî</td></tr>
                                <tr><td>Wypowiedzi</td><td id="fovGotTranscripts">‚Äî</td></tr>
                                <tr><td>G≈Çosowania</td><td id="fovGotVotings">‚Äî</td></tr>
                                <tr><td>G≈Çosy indywidualne</td><td id="fovGotVotes">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Dane per kadencja</td></tr>
                                <tr><td>Interpelacje</td><td id="fovGotInterpellations">‚Äî</td></tr>
                                <tr><td>Zapytania pisemne</td><td id="fovGotQuestions">‚Äî</td></tr>
                                <tr><td>Projekty ustaw</td><td id="fovGotBills">‚Äî</td></tr>
                                <tr><td>Ustawy</td><td id="fovGotActs">‚Äî</td></tr>
                                <tr><td>O≈õwiadczenia</td><td id="fovGotDisclosures">‚Äî</td></tr>
                            </tbody>
                            <tbody>
                                <tr class="fetch-overview-separator"><td colspan="2">Komisje</td></tr>
                                <tr><td>Komisje</td><td id="fovGotCommittees">‚Äî</td></tr>
                                <tr><td>Posiedzenia komisji</td><td id="fovGotCommitteeSittings">‚Äî</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="summary-container" id="summaryContainer"></div>

                <div class="summary-info" id="summaryInfo" style="display:none;">
                    <p><strong>Ostatnia aktualizacja:</strong> <span id="lastUpdate">Brak danych</span></p>
                    <p><strong>Kadencja:</strong> <span id="summaryTerm">-</span></p>
                    <p><strong>Instytucja:</strong> <span id="summaryInstitution">-</span></p>
                    <p><strong>≈ÅƒÖcznie rekord√≥w:</strong> <span id="summaryTotal">0</span></p>
                    <p id="lastFetchInfo" style="display:none;"><strong>Ostatnie pobieranie:</strong> <span id="lastFetchDetails">-</span></p>
                </div>

                <div id="summaryTableSection" class="summary-table-section" style="display:none;">
                    <div class="summary-table-header">
                        <h3 id="summaryTableTitle"></h3>
                        <button id="summaryTableClose" class="summary-table-close" title="Zamknij">&times;</button>
                    </div>
                    <div id="summaryTableWrap" class="summary-table-wrap"></div>
                </div>

                <div class="summary-actions" id="summaryActions" style="margin-top:12px; display:flex; gap:10px;">
                    <button id="summaryImportDb" class="console-style-btn"
                        data-help-id="summaryImportDb">üì• Import bazy</button>
                    <button id="summaryExportDb" class="console-style-btn"
                        data-help-id="summaryExportDb">üì§ Export bazy</button>
                </div>

                <div class="summary-placeholder" id="summaryPlaceholder">
                    <p>üì• Pobierz dane w sekcji ETL, aby zobaczyƒá szczeg√≥≈Çowe statystyki</p>
                </div>
            </section>

            <!-- SEKCJA 3: AI ASYSTENT -->
            <section class="app-section" data-section="3" style="display:none;">

                <!-- Powiadomienie: sekcja w budowie -->
                <div id="aiWipOverlay" class="wip-overlay hidden">
                    <div class="wip-modal">
                        <div class="wip-icon">üöß</div>
                        <h3 class="wip-title">Sekcja w trakcie budowy</h3>
                        <p class="wip-text">Modu≈Ç <strong>AI Asystent</strong> jest aktualnie w fazie rozwoju.<br>Niekt√≥re funkcje mogƒÖ dzia≈Çaƒá niestabilnie lub byƒá niekompletne.</p>
                        <button id="aiWipCloseBtn" class="wip-close-btn">Rozumiem, kontynuuj</button>
                    </div>
                </div>

                <div class="ai-two-columns">

                <!-- KOLUMNA 1: Asystent AI -->
                <div class="ai-column ai-column-chat">
                <h3>ü§ñ Asystent AI</h3>
                <div class="ai-chat-fullscreen">
                    <div class="chat-config">
                        <div class="chat-config-row">
                            <label for="aiModelSelect">Model AI:</label>
                            <div class="model-select-wrapper">
                                <label class="chat-filter-checkbox" title="Poka≈º wszystkie modele">
                                    <input type="checkbox" id="showAllModels" checked>
                                </label>
                                <select id="aiModelSelect"
                                    data-help-id="aiModelSelect">
                                    <option value="openai">OpenAI GPT-4</option>
                                    <option value="claude">Anthropic Claude 3.5</option>
                                    <optgroup label="üî• Gemini - G≈Ç√≥wne">
                                        <option value="gemini-3-flash">Gemini 3 Flash Preview</option>
                                        <option value="gemini-3-pro">Gemini 3 Pro Preview</option>
                                        <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                                        <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite</option>
                                        <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                                    </optgroup>
                                    <optgroup label="‚ö° Gemini 2.0">
                                        <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                        <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite</option>
                                        <option value="gemini-exp-1206">Gemini Exp 1206</option>
                                    </optgroup>
                                    <optgroup label="üìå Latest">
                                        <option value="gemini-flash-latest">Gemini Flash Latest</option>
                                        <option value="gemini-pro-latest">Gemini Pro Latest</option>
                                    </optgroup>
                                    <optgroup label="üé® Image & Specjalne">
                                        <option value="gemini-2.5-flash-image">Gemini 2.5 Flash Image</option>
                                        <option value="gemini-3-pro-image">Gemini 3 Pro Image</option>
                                        <option value="gemini-computer-use">Computer Use Preview</option>
                                        <option value="deep-research-pro">Deep Research Pro</option>
                                        <option value="gemini-robotics">Robotics 1.5 Preview</option>
                                    </optgroup>
                                    <optgroup label="ü§ñ Gemma (Open Models)">
                                        <option value="gemma-12b">Gemma 3 12B</option>
                                        <option value="gemma-27b">Gemma 3 27B</option>
                                    </optgroup>
                                </select>
                                <button id="toggleFavoriteBtn" class="toggle-favorite-btn" title="Dodaj/usu≈Ñ z ulubionych">‚≠ê</button>
                            </div>
                        </div>
                        
                        <div id="apiKeyRow">
                        <div class="chat-config-row">
                            <a id="apiKeyLink" href="https://platform.openai.com/api-keys" target="_blank" class="chat-api-link">
                                üîë Wygeneruj klucz API
                            </a>
                        </div>
                        
                        <div class="chat-config-row">
                            <label for="aiApiKey">Klucz API:</label>
                            <input type="password" id="aiApiKey" placeholder="sk-..." />
                            <div class="vault-status-inline" id="vaultStatus">
                                <span class="vault-lock-icon" id="vaultLockIcon">üîí</span>
                                <span id="vaultStatusText">Sesja</span>
                                <button id="vaultLockBtn" class="vault-btn-inline" title="Zablokuj klucz" style="display:none">üîí</button>
                            </div>
                        </div>
                        </div>
                        
                        <div class="chat-config-row">
                            <button id="checkModelsBtn" class="chat-check-models-btn">
                                üîç Sprawd≈∫ dostƒôpne modele Gemini
                            </button>
                        </div>
                        
                        <div class="chat-config-row">
                            <details class="chat-favorites-section">
                                <summary class="chat-favorites-toggle">‚≠ê ZarzƒÖdzaj ulubionymi</summary>
                                <div id="favoritesList" class="favorites-list"></div>
                                <div class="favorites-help">Kliknij ‚≠ê przy wybranym modelu w li≈õcie powy≈ºej, aby dodaƒá do ulubionych</div>
                            </details>
                        </div>
                    </div>
                    
                    <div id="chatMessages" class="chat-messages-fullscreen"
                        data-help-id="chatMessages"></div>
                    
                    <div class="chat-input-area">
                        <textarea id="chatInput" placeholder="Zadaj pytanie o dane parlamentarne..." rows="1"
                            data-help-id="chatInput"></textarea>
                        <button id="sendChatBtn" title="Wy≈õlij wiadomo≈õƒá"
                            data-help-id="sendChatBtn">üì§</button>
                    </div>
                </div>
                </div><!-- /ai-column-chat -->

                <!-- KOLUMNA 2: Modu≈Çy AI -->
                <div class="ai-column ai-column-modules">
                <h3>‚ú® Modu≈Çy AI</h3>
                <div class="ai-modules-grid predictions-grid">

                    <!-- AI: Auto-podsumowanie posiedze≈Ñ -->
                    <div class="prediction-card" data-prediction="sessionSummary"
                        data-help-id="predSessionSummary">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">ü§ñ</div>
                            <div>
                                <h3>Auto-podsumowanie posiedze≈Ñ <span class="ai-badge">‚ú® AI</span></h3>
                                <p>AI generuje streszczenia sesji parlamentarnych</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="sessionSummaryContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: Klasyfikacja tematyczna -->
                    <div class="prediction-card" data-prediction="topicClassification"
                        data-help-id="predTopicClassification">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üè∑Ô∏è</div>
                            <div>
                                <h3>Klasyfikacja tematyczna <span class="ai-badge">‚ú® AI</span></h3>
                                <p>Automatyczne tagowanie wypowiedzi wg tematu</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="topicClassificationContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: Sprzeczno≈õci pos≈Ça -->
                    <div class="prediction-card" data-prediction="mpContradictions"
                        data-help-id="predMpContradictions">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üîÑ</div>
                            <div>
                                <h3>Sprzeczno≈õci pos≈Ça <span class="ai-badge">‚ú® AI</span></h3>
                                <p>Zmiany stanowiska tego samego pos≈Ça w czasie</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="mpContradictionsContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: Raport AI -->
                    <div class="prediction-card" data-prediction="aiReport"
                        data-help-id="predAiReport">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üìä</div>
                            <div>
                                <h3>Raport AI <span class="ai-badge">‚ú® AI</span></h3>
                                <p>Jednym klikniƒôciem ‚Äî pe≈Çny raport analityczny</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="aiReportContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: WebLLM -->
                    <div class="prediction-card" data-prediction="webllmChat"
                        data-help-id="predWebllmChat">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üß†</div>
                            <div>
                                <h3>WebLLM ‚Äî AI lokalne <span class="ai-badge">‚ú® AI</span></h3>
                                <p>Model AI w przeglƒÖdarce, bez klucza API</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="webllmChatContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: Wykrywanie zachowa≈Ñ antypolskich -->
                    <div class="prediction-card" data-prediction="antiPolish"
                        data-help-id="predAntiPolish">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üõ°Ô∏è</div>
                            <div>
                                <h3>Wykrywanie zachowa≈Ñ antypolskich <span class="ai-badge">‚ú® AI</span></h3>
                                <p>Analiza prorosyjskich i antypa≈Ñstwowych wypowiedzi</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="antiPolishContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: Wywiad sieciowy -->
                    <div class="prediction-card" data-prediction="webIntel"
                        data-help-id="predWebIntel">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üåê</div>
                            <div>
                                <h3>Wywiad sieciowy <span class="ai-badge">‚ú® AI</span></h3>
                                <p>AI przeszukuje internet w kontek≈õcie parlamentarnym</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="webIntelContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: Wykresy AI -->
                    <div class="prediction-card" data-prediction="aiCharts"
                        data-help-id="predAiCharts">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üìä</div>
                            <div>
                                <h3>Wykresy AI <span class="ai-badge">‚ú® AI</span></h3>
                                <p>Opisz wykres ‚Äî AI wygeneruje go z danych w bazie</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="aiChartsContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- AI: Investigation Engine (hidden, iddqd to unlock) -->
                    <div class="prediction-card prediction-card--investigation" data-prediction="investigationEngine"
                        data-help-id="predInvestigationEngine"
                        id="investigationEngineCard" style="display:none;">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon inv-icon-animated">
                                <img src="https://media.giphy.com/media/3o7btNa0RUYa5E7iiQ/giphy.gif"
                                     alt="Investigation Engine"
                                     class="inv-header-gif"
                                     onerror="this.style.display='none'; this.parentElement.textContent='ü§™üîç';" />
                            </div>
                            <div>
                                <h3>Investigation Engine <span class="ai-badge">‚ú® AI</span></h3>
                                <p>Wykrywanie teorii spiskowych, ukrytych narracji i retoryki manipulacyjnej</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="investigationEngineContent" class="prediction-content"></div>
                        </div>
                    </div>

                </div><!-- /ai-modules-grid -->
                </div><!-- /ai-column-modules -->

                </div><!-- /ai-two-columns -->
            </section>

            <!-- SEKCJA 4: WYKRESY & ANALITYKA -->
            <section class="app-section" data-section="4" style="display:none;">

                <!-- Panel kontrolny wykres√≥w -->
                <div class="charts-control-panel"
                    data-help-id="chartsControlPanel">
                    <div class="charts-control-header">
                        <h3>üìä ZarzƒÖdzanie wykresami</h3>
                        <div class="charts-control-actions">
                            <button id="chartsSelectAll" class="charts-btn-small">Zaznacz wszystkie</button>
                            <button id="chartsDeselectAll" class="charts-btn-small">Odznacz wszystkie</button>
                            <button id="chartsResetOrder" class="charts-btn-small">Resetuj kolejno≈õƒá</button>
                            <button class="charts-btn-small" data-action="goto-etl">üì• Pobierz dane</button>
                            <button class="charts-btn-small" data-action="import-db">üíæ Importuj bazƒô</button>
                        </div>
                    </div>
                    <div class="charts-control-body">
                        <p class="charts-control-hint">üí° PrzeciƒÖgnij aby zmieniƒá kolejno≈õƒá, zaznacz aby pokazaƒá wykres</p>
                        <ul id="chartsOrderList" class="charts-order-list">
                            <!-- Lista bƒôdzie generowana dynamicznie przez JS -->
                        </ul>
                    </div>
                </div>

                <div id="chartsGrid" class="charts-grid">

                    <div class="chart-card" id="chartKluby" data-chart-type="kluby"
                        data-help-id="chartKluby">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üèõÔ∏è</div>
                            <div>
                                <h4>Rozk≈Çad klub√≥w parlamentarnych</h4>
                                <p>Doughnut ‚Äî liczba pos≈Ç√≥w per klub</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasKluby"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz pos≈Ç√≥w aby wy≈õwietliƒá ten wykres</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartTopPoslowie" data-chart-type="topPoslowie"
                        data-help-id="chartTopPoslowie">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üë•</div>
                            <div>
                                <h4>Top 10 najaktywniejszych pos≈Ç√≥w</h4>
                                <p>Bar ‚Äî ranking wg liczby wypowiedzi</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasTopPoslowie"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz wypowiedzi aby wy≈õwietliƒá ten wykres</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartGlosowania" data-chart-type="glosowania"
                        data-help-id="chartGlosowania">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üó≥Ô∏è</div>
                            <div>
                                <h4>Wyniki g≈Çosowa≈Ñ</h4>
                                <p>Doughnut ‚Äî za / przeciw / wstrzyma≈Ç siƒô</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasGlosowania"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz g≈Çosowania aby wy≈õwietliƒá ten wykres</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartCustom" data-chart-type="custom"
                        data-help-id="chartCustom">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üìä</div>
                            <div>
                                <h4>Wykres niestandardowy</h4>
                                <p>G≈Çosowania w czasie, komisje, interpelacje, frekwencja</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <div class="chart-card-controls">
                                <select id="customChartSelect" class="chart-select">
                                    <option value="glosowaniaTime">G≈Çosowania w czasie</option>
                                    <option value="komisje">Aktywno≈õƒá komisji</option>
                                    <option value="interpelacje">Interpelacje wg pos≈Ç√≥w</option>
                                    <option value="frekwencja">Frekwencja g≈Çosowa≈Ñ</option>
                                </select>
                                <button class="chart-refresh-btn" data-chart="custom" title="Aktualizuj">üîÑ</button>
                            </div>
                            <canvas id="canvasCustom"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz dane aby wy≈õwietliƒá ten wykres</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartNajmniejAktywni" data-chart-type="najmniejAktywni"
                        data-help-id="chartNajmniejAktywni">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üò¥</div>
                            <div>
                                <h4>Top 20 najmniej aktywnych pos≈Ç√≥w</h4>
                                <p>Bar ‚Äî pos≈Çowie z najmniejszƒÖ liczbƒÖ wypowiedzi</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasNajmniejAktywni"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz wypowiedzi i pos≈Ç√≥w aby wy≈õwietliƒá ten wykres</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartNajmniejAktywneKluby" data-chart-type="najmniejAktywneKluby"
                        data-help-id="chartNajmniejAktywneKluby">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üîª</div>
                            <div>
                                <h4>Najmniej aktywne kluby</h4>
                                <p>Bar ‚Äî aktywno≈õƒá klub√≥w per capita</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasNajmniejAktywneKluby"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz wypowiedzi i pos≈Ç√≥w aby wy≈õwietliƒá ten wykres</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartHeatmap" data-chart-type="heatmap"
                        data-help-id="chartHeatmap">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üî•</div>
                            <div>
                                <h4>Heatmapa frekwencji</h4>
                                <p>Macierz obecno≈õci pos≈Ç√≥w / klub√≥w na g≈Çosowaniach</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <div class="chart-card-controls">
                                <div class="heatmap-controls">
                                    <select id="heatmapXAxis" class="chart-select">
                                        <option value="posiedzenia">O≈õ X: Posiedzenia</option>
                                        <option value="glosowania">O≈õ X: G≈Çosowania</option>
                                    </select>
                                    <select id="heatmapYAxis" class="chart-select">
                                        <option value="poslowie">O≈õ Y: Pos≈Çowie</option>
                                        <option value="kluby">O≈õ Y: Kluby</option>
                                    </select>
                                    <select id="heatmapColor" class="chart-select">
                                        <option value="obecnosc">Kolor: Obecno≈õƒá</option>
                                        <option value="za">Kolor: G≈Çosy Za</option>
                                        <option value="przeciw">Kolor: G≈Çosy Przeciw</option>
                                        <option value="wstrzymal">Kolor: Wstrzyma≈Ç siƒô</option>
                                    </select>
                                </div>
                                <button class="chart-refresh-btn" data-chart="heatmap" title="Aktualizuj">üîÑ</button>
                            </div>
                            <canvas id="canvasHeatmap"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz g≈Çosy i pos≈Ç√≥w aby wy≈õwietliƒá heatmapƒô</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- WYKRESY ANALIZY SENTYMENTU -->
                    <div class="chart-card" id="chartSentimentDist" data-chart-type="sentimentDist"
                        data-help-id="chartSentimentDist">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üìä</div>
                            <div>
                                <h4>Rozk≈Çad sentymentu wypowiedzi</h4>
                                <p>Doughnut ‚Äî pozytywne / neutralne / negatywne</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasSentimentDist"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz wypowiedzi aby analizowaƒá sentyment</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartSentimentTime" data-chart-type="sentimentTime"
                        data-help-id="chartSentimentTime">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üìà</div>
                            <div>
                                <h4>Sentyment w czasie</h4>
                                <p>Line ‚Äî ≈õredni sentyment wg miesiƒôcy</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasSentimentTime"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz wypowiedzi aby analizowaƒá sentyment w czasie</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartSentimentParty" data-chart-type="sentimentParty"
                        data-help-id="chartSentimentParty">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üé≠</div>
                            <div>
                                <h4>Sentyment per klub</h4>
                                <p>Bar ‚Äî ≈õredni sentyment wypowiedzi per klub</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasSentimentParty"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz wypowiedzi aby analizowaƒá sentyment per klub</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="chart-card" id="chartTopSpeakers" data-chart-type="topSpeakers"
                        data-help-id="chartTopSpeakers">
                        <div class="chart-card-header">
                            <div class="chart-card-icon">üé§</div>
                            <div>
                                <h4>Top m√≥wcy - sentyment</h4>
                                <p>Bar ‚Äî najbardziej pozytywni i negatywni m√≥wcy</p>
                            </div>
                        </div>
                        <div class="chart-card-body" style="display:none;">
                            <canvas id="canvasTopSpeakers"></canvas>
                            <div class="chart-no-data">
                                <div class="chart-no-data-icon">üìä</div>
                                <div class="chart-no-data-title">Brak danych</div>
                                <div class="chart-no-data-hint">Pobierz wypowiedzi aby analizowaƒá top m√≥wc√≥w</div>
                                <div class="chart-no-data-actions">
                                    <button class="chart-no-data-btn" data-action="goto-etl">üì• Pobierz dane</button>
                                    <button class="chart-no-data-btn" data-action="import-db">üìÇ Importuj bazƒô</button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </section>
            <!-- SEKCJA 5: Ustawienia programu -->
            <section class="app-section" data-section="5" style="display:none;">
                <!-- Sekcja 2: Zmiana jƒôzyka -->
                <div class="console-style-panel">
                    <div class="console-style-header">
                        <h3>Jƒôzyk / Language</h3>
                    </div>
                    <div class="console-style-body">
                        <div class="console-style-options">
                               <button id="langPL" class="console-style-btn active" title="Polski">üáµüá± Polski</button>
                               <button id="langEN" class="console-style-btn" title="English">üá¨üáß English</button>
                               <button id="langUA" class="console-style-btn" title="–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞">üá∫üá¶ –£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</button>
                        </div>
                    </div>
                </div>
                <!-- Sekcja 3: ZarzƒÖdzanie pamiƒôciƒÖ przeglƒÖdarki -->
                <div class="console-style-panel">
                    <div class="console-style-header">
                        <h3>Pamiƒôƒá przeglƒÖdarki</h3>
                    </div>
                    <div class="console-style-body">
                        <div class="console-style-options" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
                               <button id="btnResetMemory" class="console-style-btn console-style-btn-danger"
                                   data-help-id="resetMemorySettings">Reset pamiƒôci</button>
                               <span style="font-size:0.85rem;color:var(--text-secondary)">Resetuj zapisane pozycje przycisk√≥w oraz ustawienia interfejsu do warto≈õci domy≈õlnych.</span>
                        </div>
                    </div>
                </div>
                <!-- Sekcja 3: Widoczno≈õƒá element√≥w UI -->
                <div class="console-style-panel">
                    <div class="console-style-header">
                        <h3>Widoczno≈õƒá element√≥w</h3>
                    </div>
                    <div class="console-style-body">
                        <fieldset class="etl-fieldset" style="margin-bottom:10px;background:var(--bg-secondary);border-color:var(--border-color)">
                            <legend style="color:var(--text-secondary)">Paski informacyjne</legend>
                            <div class="settings-checkboxes">
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleTopBar" checked>
                                    <span>Pasek informacyjny (g√≥ra)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBottomBar" checked>
                                    <span>Pasek statusu (d√≥≈Ç)</span>
                                </label>
                            </div>
                            <div class="settings-checkboxes" style="margin-top:8px;margin-left:16px">
                                <div style="display:flex;flex-direction:column;gap:10px;">
                                    <label class="settings-checkbox-label" style="font-size:0.9rem;background:rgba(255,180,100,0.13);">
                                        <input type="checkbox" id="toggleDbCheckNewRecords">
                                        <span>Monitoruj nowe rekordy (beta) co</span>
                                        <input type="number" id="dbCheckNewRecordsInterval" min="1" max="60" value="5" style="width:50px;margin:0 5px;padding:2px 5px;">
                                        <span>min</span>
                                        <button id="btnCheckNewRecords" class="console-style-btn" style="margin-left:8px;padding:4px 10px;font-size:0.8rem;" title="Sprawd≈∫ teraz">üîÑ</button>
                                    </label>
                                    <label class="settings-checkbox-label" style="font-size:0.9rem;background:rgba(255,180,100,0.13);">
                                        <input type="checkbox" id="toggleDbCheckDataChanges">
                                        <span>Monitoruj zmiany danych (beta) co</span>
                                        <input type="number" id="dbCheckDataChangesInterval" min="1" max="60" value="11" style="width:50px;margin:0 5px;padding:2px 5px;">
                                        <span>min</span>
                                        <button id="btnCheckDataChanges" class="console-style-btn" style="margin-left:8px;padding:4px 10px;font-size:0.8rem;" title="Sprawd≈∫ teraz">üîÑ</button>
                                    </label>
                                </div>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBarAi" checked>
                                    <span>AI</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBarLoad" checked>
                                    <span>Load</span>
                                </label>
                                <label class="settings-checkbox-label" style="background:rgba(255,180,100,0.13);">
                                    <input type="checkbox" id="toggleBarMemory">
                                    <span>Memory (beta)</span>
                                </label>
                                <label class="settings-checkbox-label" style="background:rgba(255,180,100,0.13);">
                                    <input type="checkbox" id="toggleBarStorage">
                                    <span>Storage (beta)</span>
                                </label>
                                <label class="settings-checkbox-label" style="background:rgba(255,180,100,0.13);">
                                    <input type="checkbox" id="toggleBarCache">
                                    <span>Cache (beta)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBarConsole" checked>
                                    <span>Konsola</span>
                                </label>
                                <label class="settings-checkbox-label" style="background:rgba(255,180,100,0.13);">
                                    <input type="checkbox" id="toggleBarLive">
                                    <span>Live (beta)</span>
                                </label>
                            </div>
                        </fieldset>
                        <fieldset class="etl-fieldset" style="margin-bottom:10px;background:var(--bg-secondary);border-color:var(--border-color)">
                            <legend style="color:var(--text-secondary)">Przyciski po lewej stronie</legend>
                            <div class="settings-checkboxes">
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBtnImport" checked>
                                    <span>Import bazy</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBtnExport" checked>
                                    <span>Export bazy</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBtnAi" checked>
                                    <span>Nawigator</span>
                                    <select id="btnAiTargetSelect" style="margin-left:8px;font-size:0.75rem;padding:1px 4px;background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-color);border-radius:4px">
                                        <option value="1">ETL</option>
                                        <option value="2">Podsumowanie</option>
                                        <option value="3" selected>AI Asystent</option>
                                        <option value="4">Wykresy</option>
                                        <option value="5">Ustawienia</option>
                                    </select>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBtnAbout" checked>
                                    <span>Informacje o wersji</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBtnLanguage">
                                    <span style="opacity:0.5">Zmiana jƒôzyka (niedostƒôpna)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBtnHelp" checked>
                                    <span>Podpowiedzi</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleBtnReset">
                                    <span>Reset pamiƒôci</span>
                                </label>
                            </div>
                        </fieldset>
                        <fieldset class="etl-fieldset" style="margin-bottom:10px;background:var(--bg-secondary);border-color:var(--border-color)">
                            <legend style="color:var(--text-secondary)">Dane</legend>
                            <div class="settings-checkboxes">
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleRememberEtl">
                                    <span>Pamiƒôtaj ustawienia ≈õciƒÖgania danych</span>
                                </label>
                                <label class="settings-checkbox-label" style="background:rgba(255,180,100,0.13);">
                                    <input type="checkbox" id="toggleAutoCountRecords" checked>
                                    <span>Szacuj ilo≈õci rekord√≥w na starcie (beta)</span>
                                </label>
                                <label class="settings-checkbox-label" style="background:rgba(255,180,100,0.13);">
                                    <input type="checkbox" id="toggleShowEstimate" checked>
                                    <span>Poka≈º estymacjƒô pamiƒôci i czasu (beta)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleInfoFetch" checked>
                                    <span>Informuj o ≈õciƒÖganiu danych</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleSoundAlerts" checked>
                                    <span>D≈∫wiƒôkowe alerty (b≈ÇƒÖd 503)</span>
                                </label>
                            </div>
                            <p style="font-size:0.85rem;color:var(--text-secondary);margin-top:8px;margin-bottom:6px">Szybko≈õƒá pobierania danych:</p>
                            <div class="settings-speed-group" style="margin-left:16px">
                                <label class="settings-checkbox-label">
                                    <input type="radio" name="settingsSpeed" value="normal" checked>
                                    <span>Normalnie <small style="color:var(--text-secondary)">(batch 5, 100ms delay)</small></span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="radio" name="settingsSpeed" value="fast">
                                    <span>Szybko üöÄ <small style="color:var(--text-secondary)">(batch 10, 50ms delay)</small></span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="radio" name="settingsSpeed" value="risky">
                                    <span>Ryzykownie üî• <small style="color:var(--text-secondary)">(batch 13, 25ms delay)</small></span>
                                </label>
                            </div>
                        </fieldset>
                        <fieldset class="etl-fieldset" style="margin-bottom:10px;background:var(--bg-secondary);border-color:var(--border-color)">
                            <legend style="color:var(--text-secondary)">Inne</legend>
                            <div class="settings-checkboxes">
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleNotifyDataWorkflow" checked>
                                    <span>Powiadomienie "Zasada pracy na danych" (zak≈Çadka Dane)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleNotifyAiWip" checked>
                                    <span>Powiadomienie "Sekcja w budowie" (zak≈Çadka AI Asystent)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleGameOnLoad">
                                    <span>Mini-gra üöÄ w trakcie ≈Çadowania danych (ESC ‚Äî end game)</span>
                                </label>
                                <label class="settings-checkbox-label" style="margin-left:18px">
                                    <input type="checkbox" id="toggleGameLite" checked>
                                    <span>Wersja lekka (od≈Çamki wypadajƒÖ za ekran)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleAnalyticsConsent">
                                    <span>Zgoda na Google Analytics (cookies analityczne)</span>
                                </label>
                                <label class="settings-checkbox-label">
                                    <input type="checkbox" id="toggleEmoclippy" checked>
                                    <span>üìé Spinacz ‚Äî wskaz√≥wki w trybie pomocy</span>
                                </label>
                            </div>
                        </fieldset>
                    </div>
                </div>
                <!-- Sekcja: Bezpiecze≈Ñstwo klucza API -->
                <div class="console-style-panel">
                    <div class="console-style-header">
                        <h3>üîê Bezpiecze≈Ñstwo klucza API</h3>
                    </div>
                    <div class="console-style-body">
                        <div class="console-style-description">
                            <p>Wybierz spos√≥b przechowywania klucza API dla AI Asystenta.</p>
                        </div>
                        <div class="vault-settings-panel">
                            <div class="vault-settings-row">
                                <label for="vaultMode">Tryb przechowywania:</label>
                                <select id="vaultMode" class="vault-mode-select">
                                    <option value="session">üìã Tylko sesja (domy≈õlny)</option>
                                    <option value="pin">üîê PIN + szyfrowanie AES-256</option>
                                    <option value="memory">üß† Tylko pamiƒôƒá RAM</option>
                                </select>
                            </div>
                            <div class="vault-settings-descriptions">
                                <p class="vault-desc" data-mode="session"><strong>Sesja</strong> ‚Äî klucz zapisany w sessionStorage, usuwany po zamkniƒôciu karty.</p>
                                <p class="vault-desc" data-mode="pin"><strong>PIN + AES-256</strong> ‚Äî klucz szyfrowany PINem (PBKDF2 + AES-GCM), przechowywany w localStorage.</p>
                                <p class="vault-desc" data-mode="memory"><strong>Pamiƒôƒá</strong> ‚Äî klucz tylko w pamiƒôci RAM, nigdzie nie zapisywany.</p>
                            </div>
                            <div class="vault-settings-actions">
                                <button id="vaultChangePinBtn" class="console-style-btn" style="display:none">üîÑ Zmie≈Ñ PIN</button>
                            </div>
                        </div>
                    </div>
                </div>

            </section>

            <!-- SEKCJA 6: PREDYKCJA & MODELE -->
            <section class="app-section" data-section="6" style="display:none;">
                <div class="predictions-header">
                    <h2>üîÆ Model Predykcyjny</h2>
                    <p class="predictions-subtitle">Analiza wzorc√≥w i prognozowanie na podstawie danych historycznych</p>
                </div>

                <div class="predictions-grid">
                    <!-- Card 1: Analiza agresji parlamentarnej (HOT) -->
                    <div class="prediction-card prediction-card--hot" data-prediction="aggressionAnalysis"
                        data-help-id="predAggressionAnalysis">
                        <div class="prediction-card-ribbon">HOT</div>
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üî•</div>
                            <div>
                                <h3>Analiza agresji parlamentarnej</h3>
                                <p>Kto prowokuje agresjƒô, kto jƒÖ zaczyna, stereotypowe pro≈õby o spok√≥j</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="aggressionAnalysisContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 2: Profil parlamentarzysty -->
                    <div class="prediction-card prediction-card--orange" data-prediction="mpProfile"
                        data-help-id="predMpProfile">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üë§</div>
                            <div>
                                <h3>Profil parlamentarzysty</h3>
                                <p>Szczeg√≥≈Çowy profil wybranego pos≈Ça</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="mpProfileContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 3: Profil klubu/partii -->
                    <div class="prediction-card prediction-card--orange" data-prediction="clubProfile"
                        data-help-id="predClubProfile">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üèõÔ∏è</div>
                            <div>
                                <h3>Profil klubu / partii</h3>
                                <p>Statystyki wybranego klubu</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="clubProfileContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 4: Profil komisji -->
                    <div class="prediction-card prediction-card--orange" data-prediction="committeeProfile"
                        data-help-id="predCommitteeProfile">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üìã</div>
                            <div>
                                <h3>Profil komisji</h3>
                                <p>Szczeg√≥≈Çy wybranej komisji</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="committeeProfileContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 4: Dyscyplina klubowa -->
                    <div class="prediction-card" data-prediction="discipline"
                        data-help-id="predDiscipline">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üéØ</div>
                            <div>
                                <h3>Dyscyplina klubowa</h3>
                                <p>Zgodno≈õƒá g≈Çosowa≈Ñ z liniƒÖ partyjnƒÖ</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="disciplineContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 5: Wykrywanie buntownik√≥w -->
                    <div class="prediction-card prediction-card--blue" data-prediction="rebels"
                        data-help-id="predRebels">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">‚ö†Ô∏è</div>
                            <div>
                                <h3>Wykrywanie anomalii</h3>
                                <p>Pos≈Çowie g≈ÇosujƒÖcy wbrew klubowi</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="rebelsContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 6: Macierz koalicyjna -->
                    <div class="prediction-card" data-prediction="coalition"
                        data-help-id="predCoalitions">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">ü§ù</div>
                            <div>
                                <h3>Potencjalne koalicje</h3>
                                <p>Podobie≈Ñstwo g≈Çosowania miƒôdzy klubami</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="coalitionContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 4: Predykcja aktywno≈õci -->
                    <div class="prediction-card" data-prediction="activity"
                        data-help-id="predTrend">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üìà</div>
                            <div>
                                <h3>Trend aktywno≈õci</h3>
                                <p>Przewidywanie przysz≈Çej aktywno≈õci</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="activityContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 5: Analiza online -->
                    <div class="prediction-card prediction-card--blue" data-prediction="online"
                        data-help-id="predSentiment">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üì∞</div>
                            <div>
                                <h3>Analiza online</h3>
                                <p>Analizuj tre≈õci gazet</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="onlineContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 6: Frekwencja & Absencja -->
                    <div class="prediction-card" data-prediction="attendance"
                        data-help-id="predAttendance">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üìä</div>
                            <div>
                                <h3>Frekwencja & Absencja</h3>
                                <p>Ranking obecno≈õci pos≈Ç√≥w na g≈Çosowaniach</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="attendanceContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 7: Polaryzacja g≈Çosowa≈Ñ -->
                    <div class="prediction-card" data-prediction="polarization"
                        data-help-id="predPolarization">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">‚ö°</div>
                            <div>
                                <h3>Polaryzacja g≈Çosowa≈Ñ</h3>
                                <p>Jak podzielone sƒÖ g≈Çosowania?</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="polarizationContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 8: Ranking aktywno≈õci pos≈Ç√≥w -->
                    <div class="prediction-card" data-prediction="activityRank"
                        data-help-id="predActivityRank">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üèÜ</div>
                            <div>
                                <h3>Ranking aktywno≈õci</h3>
                                <p>Composite score aktywno≈õci pos≈Ç√≥w</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="activityRankContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 9: Tempo legislacyjne -->
                    <div class="prediction-card" data-prediction="legislation"
                        data-help-id="predLegislation">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">‚è±Ô∏è</div>
                            <div>
                                <h3>Tempo legislacyjne</h3>
                                <p>Szybko≈õƒá procedowania ustaw</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="legislationContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 10: Analiza interpelacji -->
                    <div class="prediction-card" data-prediction="interpellations"
                        data-help-id="predInterpellations">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üì¨</div>
                            <div>
                                <h3>Analiza interpelacji</h3>
                                <p>Tematy i aktywno≈õƒá interpelacyjna</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="interpellationsContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 11: Sieƒá komisji -->
                    <div class="prediction-card" data-prediction="committees"
                        data-help-id="predCommittees">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üîó</div>
                            <div>
                                <h3>Sieƒá komisji</h3>
                                <p>Wsp√≥≈Çpraca miƒôdzykomisyjna pos≈Ç√≥w</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="committeesContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 12: Kontrowersyjne wypowiedzi -->
                    <div class="prediction-card" data-prediction="controversialSpeeches"
                        data-help-id="predControversialSpeeches">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üî•</div>
                            <div>
                                <h3>Kontrowersyjne wypowiedzi</h3>
                                <p>Najbardziej agresywne i negatywne wystƒÖpienia</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="controversialSpeechesContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 13: Sprzeczne g≈Çosowania -->
                    <div class="prediction-card" data-prediction="contradictoryVotes"
                        data-help-id="predContradictoryVotes">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">‚öîÔ∏è</div>
                            <div>
                                <h3>Sprzeczne g≈Çosowania</h3>
                                <p>Pos≈Çowie g≈ÇosujƒÖcy wbrew linii klubu</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="contradictoryVotesContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 14: Ryzyko odej≈õcia z klubu -->
                    <div class="prediction-card" data-prediction="defectionRisk"
                        data-help-id="predDefectionRisk">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üö™</div>
                            <div>
                                <h3>Ryzyko odej≈õcia z klubu</h3>
                                <p>Scoring prawdopodobie≈Ñstwa zmiany partii</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="defectionRiskContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 15: Prognoza wyniku g≈Çosowania -->
                    <div class="prediction-card" data-prediction="votePredictor"
                        data-help-id="predVotePredictor">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üéØ</div>
                            <div>
                                <h3>Prognoza g≈Çosowania</h3>
                                <p>Symulacja wyniku na podstawie historii</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="votePredictorContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 16: Barometr napiƒôcia politycznego -->
                    <div class="prediction-card" data-prediction="tensionBarometer"
                        data-help-id="predTensionBarometer">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üå°Ô∏è</div>
                            <div>
                                <h3>Barometr napiƒôcia</h3>
                                <p>Trend radykalizacji debaty politycznej</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="tensionBarometerContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 17: Prognoza koalicji -->
                    <div class="prediction-card" data-prediction="coalitionForecast"
                        data-help-id="predCoalitionForecast">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">ü§ù</div>
                            <div>
                                <h3>Prognoza koalicji</h3>
                                <p>Zbie≈ºno≈õƒá g≈Çosowa≈Ñ miƒôdzy klubami w czasie</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="coalitionForecastContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 18: Predykcja aktywno≈õci pos≈Ça -->
                    <div class="prediction-card" data-prediction="activityForecast"
                        data-help-id="predActivityForecast">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üìà</div>
                            <div>
                                <h3>Predykcja aktywno≈õci</h3>
                                <p>Prognoza przysz≈Çej aktywno≈õci pos≈Ç√≥w</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="activityForecastContent" class="prediction-content"></div>
                        </div>
                    </div>

                    <!-- Card 19: Ghost Voting -->
                    <div class="prediction-card" data-prediction="ghostVoting"
                        data-help-id="predGhostVoting">
                        <div class="prediction-card-header">
                            <div class="prediction-card-icon">üëª</div>
                            <div>
                                <h3>Podejrzane g≈Çosowania</h3>
                                <p>Wykrywanie g≈Ços√≥w przy jednoczesnej nieobecno≈õci</p>
                            </div>
                        </div>
                        <div class="prediction-card-body" style="display:none;">
                            <div id="ghostVotingContent" class="prediction-content"></div>
                        </div>
                    </div>
                </div>

                <!-- Empty state gdy brak danych -->
                <div id="predictionsEmptyState" class="predictions-empty-state" style="display:none;">
                    <div class="predictions-empty-icon">üîÆ</div>
                    <h3>Brak danych do analizy</h3>
                    <p>Aby wykorzystaƒá modele predykcyjne, najpierw pobierz dane g≈Çosowa≈Ñ i wypowiedzi.</p>
                    <div class="predictions-empty-actions">
                        <button class="prediction-btn-primary" data-action="goto-etl">üì• Pobierz dane</button>
                        <button class="prediction-btn-secondary" data-action="import-db">üíæ Importuj bazƒô</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- BOTTOM NAVIGATION BAR (Carousel) -->
        <nav class="bottom-nav" id="bottomNav">
            <div class="nav-carousel" id="navCarousel">
                <div class="nav-item active" data-section="1"
                    data-help-id="navDane">
                    <div class="nav-icon">üì•</div>
                    <div class="nav-label">Dane</div>
                </div>
                <div class="nav-item" data-section="2"
                    data-help-id="navPodsumowanie">
                    <div class="nav-icon">üìä</div>
                    <div class="nav-label">Podsumowanie</div>
                </div>
                <div class="nav-item" data-section="3"
                    data-help-id="navAI">
                    <div class="nav-icon">ü§ñ</div>
                    <div class="nav-label">AI Asystent</div>
                </div>
                <div class="nav-item" data-section="4"
                    data-help-id="navWykresy">
                    <div class="nav-icon">üìà</div>
                    <div class="nav-label">Wykresy</div>
                </div>
                <div class="nav-item" data-section="6"
                    data-help-id="navPredykcja">
                    <div class="nav-icon">üîÆ</div>
                    <div class="nav-label">Predykcja</div>
                </div>
                <div class="nav-item" data-section="5"
                    data-help-id="navUstawienia">
                    <div class="nav-icon">‚öôÔ∏è</div>
                    <div class="nav-label">Ustawienia</div>
                </div>
            </div>
        </nav>

        <footer>
            <p>
                üöÄ Projekt open-source | 
                <a href="https://github.com/michalstankiewicz4-cell/NostraDamnOS" target="_blank">GitHub</a>
            </p>
        </footer>
    </div>

    <!-- Floating UI Buttons -->
    <button id="aiChatBtn" class="floating-btn btn-ai-chat" title="AI Asystent"
        data-help-id="btnAiChat">ü§ñ</button>
    <button id="exportDbBtn" class="floating-btn btn-export" title="Export bazy danych"
        data-help-id="btnExport">üì§</button>
    <button id="importDbBtn" class="floating-btn btn-import" title="Import bazy danych"
        data-help-id="btnImport">üì•</button>
    <button id="helpBtn" class="floating-btn btn-help" title="Pomoc interaktywna"
        data-help-id="btnHelp">‚ùì</button>
    <button id="aboutBtn" class="floating-btn btn-rodo" title="O projekcie"
        data-help-id="btnAbout">‚ÑπÔ∏è</button>
    <button id="languageBtn" class="floating-btn btn-language" title="Zmie≈Ñ jƒôzyk"
        data-help-id="btnLanguage">üáµüá±</button>
    <button id="resetMemoryBtn" class="floating-btn btn-reset-memory" title="Reset pamiƒôci" style="display:none"
        data-help-id="btnResetMemory">üóëÔ∏è</button>

    <!-- Help overlay (created dynamically by help.js) -->

    <!-- Floating Status Bar (Bottom) -->
    <div id="floatingStatusBar" class="floating-status-bar">

        <!-- [Wersja] -->
        <div id="versionSection" class="status-bar-section"
            data-help-id="statusVersion">
            <span class="status-bar-label">v<span id="programVersion">4.0.0</span></span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Baza] -->
        <div id="statusIndicators" class="status-bar-section"
            data-help-id="statusDb">
            <span class="status-bar-label">Baza:</span>
            <div class="status-bar-lamps">
                <div class="floating-lamp floating-lamp-error" id="floatingStatusDbState" title="Stan bazy danych"></div>
                <div class="floating-lamp floating-lamp-ok" id="floatingStatusRecords" title="Stan rekord√≥w w API"></div>
                <div class="floating-lamp floating-lamp-ok" id="floatingStatusValidity" title="Stan poprawno≈õci danych"></div>
            </div>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [AI] -->
        <div id="aiStatusSection" class="status-bar-section"
            data-help-id="statusAI">
            <span class="status-bar-label">AI:</span>
            <div id="aiStatusLamps" class="status-bar-lamps"></div>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Load] -->
        <div id="etlProgressSection" class="status-bar-section" title="Pasek ≈Çadowania danych z API"
            data-help-id="statusLoad">
            <span class="status-bar-label">Load:</span>
            <div id="loadLamp" class="floating-lamp floating-lamp-idle" title="Status ≈Çadowania"></div>
            <div class="progress-track">
                <div id="etlProgressBar" class="progress-bar" style="width:0%"></div>
            </div>
            <span id="etlProgressPercent" class="progress-percent" style="display:none;">0%</span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Memory] -->
        <div id="memorySection" class="status-bar-section" title="Zajƒôto≈õƒá pamiƒôci przeglƒÖdarki"
            data-help-id="statusMemory">
            <span class="status-bar-label">Memory:</span>
            <div id="memoryLamp" class="floating-lamp floating-lamp-ok" title="Stan pamiƒôci"></div>
            <div class="progress-track">
                <div id="memoryProgressBar" class="progress-bar" style="width:0%"></div>
            </div>
            <span id="memoryPercent" class="progress-percent">0%</span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Storage] -->
        <div id="storageSection" class="status-bar-section" title="Zajƒôto≈õƒá localStorage (limit ~5 MB)"
            data-help-id="statusStorage">
            <span class="status-bar-label">Storage:</span>
            <div id="storageLamp" class="floating-lamp floating-lamp-ok" title="Stan localStorage"></div>
            <div class="progress-track">
                <div id="storageProgressBar" class="progress-bar" style="width:0%"></div>
            </div>
            <span id="storagePercent" class="progress-percent">0%</span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Cache] -->
        <div id="cacheSection" class="status-bar-section" title="Zajƒôto≈õƒá cache bazy danych"
            data-help-id="statusCache">
            <span class="status-bar-label">Cache:</span>
            <div id="cacheBar" class="cache-bar"></div>
        </div>

        <!-- Spacer -->
        <div class="status-bar-spacer"></div>

        <div class="status-bar-separator"></div>

        <!-- [Live] -->
        <div id="liveSection" class="status-bar-section status-bar-live" title="Status transmisji Sejmu - kliknij aby obejrzeƒá" style="display:none;"
            data-help-id="statusLive">
            <div id="liveLamp" class="floating-lamp floating-lamp-idle" title="Brak transmisji"></div>
            <span class="status-bar-label">LIVE</span>
        </div>

        <div class="status-bar-separator"></div>

        <!-- [Konsola] -->
        <div id="consoleSection" class="status-bar-section status-bar-console" title="Otw√≥rz konsolƒô (Ctrl+`)"
            data-help-id="statusConsole">
            <div id="consoleLamp" class="floating-lamp floating-lamp-ok" title="Status konsoli"></div>
            <span class="status-bar-label">KONSOLA</span>
        </div>
    </div>

    <!-- Info Detail Panel (top-right corner) -->
    <div id="etlDetailPanel" class="etl-detail-panel" style="display:none;"
        data-help-id="detailPanel">
        <div class="etl-detail-header">
            <span>Panel informacyjny</span>
        </div>
        <div id="etlDetailContent" class="etl-detail-content">
        
        <!-- Sekcja: ≈öciƒÖganie danych -->
        <div id="etlDetailFetchSection" class="etl-detail-section" style="display:none;">
            <div class="etl-detail-section-title">üì• Pobieranie danych</div>
            <div id="etlDetailStage" class="etl-detail-stage">Inicjalizacja...</div>
            <div class="etl-detail-progress">
                <div class="progress-track" style="max-width:none;">
                    <div id="etlDetailBar" class="progress-bar" style="width:0%"></div>
                </div>
                <span id="etlDetailPercent" class="progress-percent">0%</span>
            </div>
            <div id="etlDetailStats" class="etl-detail-stats"></div>
            <div id="etlDetailSubProgress" class="etl-detail-stats" style="font-weight:600;"></div>
            <div id="etlDetailLinks" class="etl-detail-links"></div>
        </div>


        </div><!-- /etlDetailContent -->
    </div>



    <!-- Live Stream Modal -->
    <div id="liveStreamModal" class="live-stream-modal" style="display:none;">
        <div class="live-stream-modal-overlay"></div>
        <div class="live-stream-modal-content">
            <div class="live-stream-modal-header">
                <span class="live-stream-modal-title">üî¥ Transmisja Sejmu na ≈ºywo</span>
                <button id="closeLiveStream" class="live-stream-modal-close">√ó</button>
            </div>
            <div class="live-stream-modal-body">
                <iframe 
                    id="liveStreamIframe"
                    src=""
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                </iframe>
            </div>
        </div>
    </div>

    <!-- Floating Console Panel -->
    <div id="floatingConsolePanel" class="floating-console-panel">
        <div class="floating-console-header">
            <span class="floating-console-title">üìã Console</span>
            <button id="closeFloatingConsole" class="floating-console-close">√ó</button>
        </div>
        <div id="floatingConsoleLogs" class="floating-console-logs">
        </div>
    </div>

    <!-- Modu≈Çy -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.10.3/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <script type="module" src="api-handler-v2.js"></script>
    <script type="module">
        // Import needed functions
        import { getCacheStatus } from './pipeline.js';

        // Startup integrity check
        async function runStartupCheck() {
            try {
                // Wait for db2.database to be available (max 5 seconds)
                for (let i = 0; i < 50; i++) {
                    if (window.db2?.database) break;
                    await new Promise(r => setTimeout(r, 100));
                }

                if (!window.db2?.database) {
                    console.warn('[Startup Check] db2 database not initialized');
                    return;
                }

                const cache = getCacheStatus(window.db2);
                console.log('[Startup Check] Cache status:', cache);

                // Skip if database is empty
                if (!cache.initialized || !cache.totalRecords) {
                    console.log('[Startup Check] ‚úÖ Database empty - no verification needed');
                    return;
                }

                console.log('[Startup Check] Running verification...');

                const { verifyDatabase } = await import('./pipeline.js');
                const report = await verifyDatabase(window.db2);
                const hasNew = report.results.some(r => r.status === 'new');
                if (hasNew) {
                    console.warn('[Startup Check] ‚ö†Ô∏è New data available in API:', report.results.filter(r => r.status === 'new'));
                } else {
                    console.log('[Startup Check] ‚úÖ Database matches API');
                }
            } catch (err) {
                console.error('[Startup Check] Error:', err);
            }
        }

        // Run check after page loads
        document.addEventListener('DOMContentLoaded', () => {
            runStartupCheck().catch(err => console.error('[Startup] Fatal error:', err));
        });

        // Expose for debugging
        window.runStartupCheck = runStartupCheck;
    </script>
    <script type="module" src="etl-bridge.js"></script>
    <script type="module" src="models.js"></script>
    <script type="module" src="modules/toast.js"></script>

        <!-- Konsola: domy≈õlny styl -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                document.body.classList.add('console-modern');
                window.updateLogDefaultColor && window.updateLogDefaultColor('console-modern');
            });
        </script>

        <!-- RSS.gov toggle logic -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const radios = document.querySelectorAll('input[name="etlInst"]');
                const sejmFieldsets = document.querySelectorAll('.etl-sejm-fieldset');
                const fieldTerm = document.getElementById('etlFieldTerm');
                const fieldRange = document.getElementById('etlFieldRange');
                const rssPanel = document.getElementById('rssPanel');
                const internetBox = document.querySelector('.etl-internet-api-box');

                function toggleETLView(value) {
                    const isRss = (value === 'rss');

                    // Hide/show Kadencja & Zakres posiedze≈Ñ
                    if (fieldTerm) fieldTerm.style.display = isRss ? 'none' : '';
                    if (fieldRange) fieldRange.style.display = isRss ? 'none' : '';

                    // Hide/show Sejm-specific fieldsets (Dane podstawowe, per posiedzenie, per kadencja, komisje)
                    sejmFieldsets.forEach(fs => fs.style.display = isRss ? 'none' : '');

                    // Hide/show Internet API box
                    if (internetBox) internetBox.style.display = isRss ? 'none' : '';

                    // Show/hide RSS panel
                    if (rssPanel) rssPanel.style.display = isRss ? '' : 'none';

                    // Update institution label in summary
                    const instLabel = document.getElementById('etlInstitution');
                    if (instLabel) {
                        if (isRss) instLabel.textContent = 'RSS.gov';
                        else instLabel.textContent = value === 'senat' ? 'Senat' : 'Sejm';
                    }
                }

                radios.forEach(radio => {
                    radio.addEventListener('change', () => toggleETLView(radio.value));
                });

                // Expose for ETL settings restore
                window._toggleETLView = toggleETLView;

                // RSS select/deselect all buttons
                const rssSelectAll = document.getElementById('rssSelectAll');
                const rssDeselectAll = document.getElementById('rssDeselectAll');
                if (rssSelectAll) {
                    rssSelectAll.addEventListener('click', () => {
                        rssPanel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
                    });
                }
                if (rssDeselectAll) {
                    rssDeselectAll.addEventListener('click', () => {
                        rssPanel.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                    });
                }

                // Dodaj linki do ka≈ºdego ≈∫r√≥d≈Ça RSS
                rssPanel.querySelectorAll('input[type="checkbox"][data-rss-url]').forEach(cb => {
                    const feedUrl = cb.dataset.rssUrl;
                    // Preferuj jawny data-site-url; dla feed√≥w XML/RSS linkuj do originu; dla stron HTML ‚Äî bezpo≈õrednio
                    let siteUrl = cb.dataset.siteUrl || feedUrl;
                    if (!cb.dataset.siteUrl && /\.(xml|rss|atom)$|\/feed\/?$/.test(feedUrl)) {
                        try { siteUrl = new URL(feedUrl).origin; } catch { /* zostaw feedUrl */ }
                    }
                    if (cb.disabled) return; // nie dodawaj linku do wy≈ÇƒÖczonych pozycji
                    const a = document.createElement('a');
                    a.href = siteUrl;
                    a.target = '_blank';
                    a.rel = 'noopener noreferrer';
                    a.title = siteUrl;
                    a.textContent = 'üîó';
                    a.style.cssText = 'margin-left:6px;font-size:0.85rem;text-decoration:none;opacity:0.7;flex-shrink:0;';
                    a.addEventListener('mouseenter', () => a.style.opacity = '1');
                    a.addEventListener('mouseleave', () => a.style.opacity = '0.7');
                    cb.closest('.checkbox-item').appendChild(a);
                });
            });
        </script>

        <!-- Reset pamiƒôci przeglƒÖdarki -->
        <script type="module">
            import { resetFloatingButtonPositions } from './modules/floating-drag.js';

            document.addEventListener('DOMContentLoaded', () => {
                const resetBtn = document.getElementById('btnResetMemory');
                resetBtn?.addEventListener('click', () => {
                    if (confirm('Czy na pewno chcesz zresetowaƒá pamiƒôƒá przeglƒÖdarki?\n\nTo usunie zapisane pozycje przycisk√≥w i ustawienia interfejsu.')) {
                        resetFloatingButtonPositions();
                        localStorage.removeItem('uiVisibility');
                        localStorage.removeItem('nostradamnos_etlSettings');
                        location.reload();
                    }
                });
            });
        </script>
    
    <!-- Memory Usage Monitor -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const memBar = document.getElementById('memoryProgressBar');
                const memPct = document.getElementById('memoryPercent');
                const memLamp = document.getElementById('memoryLamp');

                function updateMemory() {
                    if (performance && performance.memory) {
                        const used = performance.memory.usedJSHeapSize;
                        const total = performance.memory.jsHeapSizeLimit;
                        const pct = Math.round((used / total) * 100);
                        memBar.style.width = pct + '%';
                        memPct.textContent = pct + '%';
                        memBar.style.background = pct > 80 ? '#f56565' : pct > 50 ? '#f6ad55' : '#48bb78';

                        if (memLamp) {
                            memLamp.className = 'floating-lamp';
                            if (pct > 90) {
                                memLamp.classList.add('floating-lamp-error');
                            } else if (pct > 70) {
                                memLamp.classList.add('floating-lamp-warning');
                            } else {
                                memLamp.classList.add('floating-lamp-ok');
                            }
                        }
                    } else {
                        memPct.textContent = 'N/A';
                    }
                }

                updateMemory();
                setInterval(updateMemory, 3000);
            });
        </script>

    <!-- localStorage Usage Monitor -->
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                const stBar = document.getElementById('storageProgressBar');
                const stPct = document.getElementById('storagePercent');
                const stLamp = document.getElementById('storageLamp');
                const LIMIT = 5 * 1024 * 1024; // 5 MB

                function updateStorage() {
                    let totalBytes = 0;
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        totalBytes += (key.length + localStorage.getItem(key).length) * 2; // UTF-16
                    }
                    const pct = Math.min(100, Math.round((totalBytes / LIMIT) * 100));
                    const usedMB = (totalBytes / (1024 * 1024)).toFixed(1);

                    if (stBar) {
                        stBar.style.width = pct + '%';
                        stBar.style.background = pct > 85 ? '#f56565' : pct > 60 ? '#f6ad55' : '#48bb78';
                    }
                    if (stPct) stPct.textContent = `${usedMB}MB`;
                    if (stLamp) {
                        stLamp.className = 'floating-lamp';
                        if (pct > 90) stLamp.classList.add('floating-lamp-error');
                        else if (pct > 70) stLamp.classList.add('floating-lamp-warning');
                        else stLamp.classList.add('floating-lamp-ok');
                    }
                }

                updateStorage();
                setInterval(updateStorage, 5000);
                // Update after fetch completes
                window.addEventListener('storage', updateStorage);
            });
        </script>

    <!-- Cache Bar Logic -->
    <script type="module">
        import { db2 } from './modules/database-v2.js';

        const cacheModules = [
            { table: 'poslowie', label: 'Pos≈Çowie', statKey: 'poslowie' },
            { table: 'posiedzenia', label: 'Posiedzenia', reqKey: 'sittings', statKey: 'posiedzenia' },
            { table: 'wypowiedzi', label: 'Wypowiedzi', reqKey: 'transcripts', statKey: 'wypowiedzi' },
            { table: 'glosowania', label: 'G≈Çosowania', reqKey: 'votings', statKey: 'glosowania' },
            { table: 'glosy', label: 'G≈Çosy', statKey: 'glosy' },
            { table: 'interpelacje', label: 'Interpelacje', reqKey: 'interpelacje', statKey: 'interpelacje' },
            { table: 'zapytania', label: 'Zapytania pisemne', reqKey: 'zapytania', statKey: 'zapytania' },
            { table: 'zapytania_odpowiedzi', label: 'Odpowiedzi na zapytania', statKey: 'zapytania_odpowiedzi' },
            { table: 'projekty_ustaw', label: 'Projekty ustaw', reqKey: 'projekty_ustaw', statKey: 'projekty_ustaw' },
            { table: 'ustawy', label: 'Ustawy (akty prawne)', reqKey: 'ustawy', statKey: 'ustawy' },
            { table: 'komisje', label: 'Komisje', statKey: 'komisje' },
            { table: 'komisje_posiedzenia', label: 'Posiedzenia komisji', statKey: 'komisje_posiedzenia' },
            { table: 'komisje_wypowiedzi', label: 'Wypowiedzi komisji', statKey: 'komisje_wypowiedzi', disabled: true },
            { table: 'oswiadczenia_majatkowe', label: 'O≈õwiadczenia majƒÖtkowe', statKey: 'oswiadczenia_majatkowe', disabled: true }
        ];

        function updateCacheBar() {
            const bar = document.getElementById('cacheBar');
            if (!bar) return;

            let expected = {};
            try {
                const lf = JSON.parse(localStorage.getItem('nostradamnos_lastFetch') || '{}');
                const req = lf.requestedCounts || {};
                const stats = lf.stats || {};
                for (const mod of cacheModules) {
                    const fromReq = mod.reqKey ? (req[mod.reqKey] || 0) : 0;
                    const fromStats = mod.statKey ? (stats[mod.statKey] || 0) : 0;
                    expected[mod.table] = Math.max(fromReq, fromStats);
                }
            } catch { /* ignore */ }

            // Pokrycie posiedze≈Ñ: wypowiedzi, g≈Çosowania i g≈Çosy indywidualne
            let wypCoverage = null;
            let glosCoverage = null;
            let glosyCoverage = null;
            // Pokrycie komisji: ile komisji ma posiedzenia/wypowiedzi vs total
            let komisjeCoverage = null;
            let komPosiedCoverage = null;
            let komWypowCoverage = null;
            if (db2.database) {
                try {
                    const totalR = db2.database.exec('SELECT COUNT(*) FROM posiedzenia');
                    const total = totalR[0]?.values[0]?.[0] || 0;
                    if (total > 0) {
                        const wypR = db2.database.exec('SELECT COUNT(DISTINCT id_posiedzenia) FROM wypowiedzi');
                        wypCoverage = { covered: wypR[0]?.values[0]?.[0] || 0, total };
                        const glosR = db2.database.exec('SELECT COUNT(DISTINCT id_posiedzenia) FROM glosowania');
                        glosCoverage = { covered: glosR[0]?.values[0]?.[0] || 0, total };
                        const glosyR = db2.database.exec('SELECT COUNT(DISTINCT g.id_posiedzenia) FROM glosy gl JOIN glosowania g ON gl.id_glosowania = g.id_glosowania');
                        glosyCoverage = { covered: glosyR[0]?.values[0]?.[0] || 0, total };
                    }
                } catch { /* ignore */ }

                // Komisje: sprawd≈∫ czy wybrano wszystkie czy jednƒÖ
                try {
                    const lfc = JSON.parse(localStorage.getItem('nostradamnos_lastFetchConfig') || '{}');
                    const committees = Array.isArray(lfc.committees) && lfc.committees.length > 0 ? lfc.committees : ['all'];
                    const allSelected = committees.includes('all');

                    // Ile komisji w API (z etl-bridge requestedCounts lub z bazy)
                    const totalKomR = db2.database.exec('SELECT COUNT(*) FROM komisje');
                    const totalKom = totalKomR[0]?.values[0]?.[0] || 0;

                    if (totalKom > 0) {
                        // Komisje: zielone gdy all, ≈º√≥≈Çte gdy wybrane
                        komisjeCoverage = { allSelected, totalKom };

                        // Posiedzenia komisji: ile komisji ma posiedzenia
                        const komPR = db2.database.exec('SELECT COUNT(DISTINCT id_komisji) FROM komisje_posiedzenia');
                        const komPCovered = komPR[0]?.values[0]?.[0] || 0;
                        komPosiedCoverage = { covered: komPCovered, total: totalKom, allSelected };

                        // Wypowiedzi komisji: ile komisji ma wypowiedzi
                        const komWR = db2.database.exec('SELECT COUNT(DISTINCT kp.id_komisji) FROM komisje_wypowiedzi kw JOIN komisje_posiedzenia kp ON kw.id_posiedzenia_komisji = kp.id_posiedzenia_komisji');
                        const komWCovered = komWR[0]?.values[0]?.[0] || 0;
                        komWypowCoverage = { covered: komWCovered, total: totalKom, allSelected };
                    }
                } catch { /* ignore */ }
            }

            bar.innerHTML = '';
            for (const mod of cacheModules) {
                const seg = document.createElement('div');
                seg.className = 'cache-segment';

                // Wy≈ÇƒÖczone modu≈Çy (API niedostƒôpne)
                if (mod.disabled) {
                    seg.classList.add('disabled');
                    seg.title = `${mod.label}: API niedostƒôpne`;
                    bar.appendChild(seg);
                    continue;
                }

                let count = 0;
                if (db2.database) {
                    try {
                        const r = db2.database.exec(`SELECT COUNT(*) FROM ${mod.table}`);
                        count = r[0]?.values[0]?.[0] || 0;
                    } catch { /* table may not exist */ }
                }

                // Wypowiedzi, g≈Çosowania, g≈Çosy: por√≥wnaj pokrycie posiedze≈Ñ
                const cov = mod.table === 'wypowiedzi' ? wypCoverage : mod.table === 'glosowania' ? glosCoverage : mod.table === 'glosy' ? glosyCoverage : null;
                // Komisje: por√≥wnaj pokrycie komisji
                const komCov = mod.table === 'komisje' ? komisjeCoverage
                    : mod.table === 'komisje_posiedzenia' ? komPosiedCoverage
                    : mod.table === 'komisje_wypowiedzi' ? komWypowCoverage : null;
                if (cov) {
                    if (count > 0 && cov.covered >= cov.total) {
                        seg.classList.add('cached');
                        seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} (${cov.covered}/${cov.total} posiedze≈Ñ)`;
                    } else if (count > 0) {
                        seg.classList.add('partial');
                        seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} (${cov.covered}/${cov.total} posiedze≈Ñ)`;
                    } else {
                        seg.title = `${mod.label}: puste`;
                    }
                } else if (komCov && count > 0) {
                    if (mod.table === 'komisje') {
                        // Komisje: zielone gdy all, ≈º√≥≈Çte gdy wybrana jedna
                        if (komCov.allSelected) {
                            seg.classList.add('cached');
                            seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} (wszystkie)`;
                        } else {
                            seg.classList.add('partial');
                            seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} (wybrane)`;
                        }
                    } else {
                        // komisje_posiedzenia / komisje_wypowiedzi
                        if (komCov.allSelected && komCov.covered >= komCov.total) {
                            seg.classList.add('cached');
                            seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} (${komCov.covered}/${komCov.total} komisji)`;
                        } else {
                            seg.classList.add('partial');
                            seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} (${komCov.covered}/${komCov.total} komisji)`;
                        }
                    }
                } else {
                    const exp = expected[mod.table] || 0;
                    if (count > 0 && (exp === 0 || count >= exp)) {
                        seg.classList.add('cached');
                        seg.title = exp > 0
                            ? `${mod.label}: ${count.toLocaleString('pl-PL')} (kompletne)`
                            : `${mod.label}: ${count.toLocaleString('pl-PL')}`;
                    } else if (count > 0) {
                        seg.classList.add('partial');
                        seg.title = `${mod.label}: ${count.toLocaleString('pl-PL')} / ${exp.toLocaleString('pl-PL')}`;
                    } else {
                        seg.title = `${mod.label}: puste`;
                    }
                }
                bar.appendChild(seg);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateCacheBar();
            setInterval(updateCacheBar, 5000);
        });
        window._updateCacheBar = updateCacheBar;
    </script>

    <!-- Bottom Navigation Logic (Carousel) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const carousel = document.getElementById('navCarousel');
            const nav = document.getElementById('bottomNav');
            const sections = document.querySelectorAll('.app-section');
            if (!carousel || !nav) return;

            // Collect original items and their section numbers
            const origItems = [...carousel.querySelectorAll('.nav-item')];
            const count = origItems.length;
            const sectionOrder = origItems.map(el => el.dataset.section);

            // Clone items: prepend + append full set for infinite illusion
            const prependClones = origItems.map(el => { const c = el.cloneNode(true); c.classList.add('nav-clone'); return c; });
            const appendClones = origItems.map(el => { const c = el.cloneNode(true); c.classList.add('nav-clone'); return c; });
            prependClones.reverse().forEach(c => carousel.prepend(c));
            appendClones.forEach(c => carousel.append(c));

            const allItems = [...carousel.querySelectorAll('.nav-item')];

            // --- PIXEL-BASED POSITIONING ---
            // scrollPx = the carousel pixel coordinate that should appear at center of nav
            function getNavWidth() {
                return nav.clientWidth - parseFloat(getComputedStyle(nav).paddingLeft) * 2;
            }

            // Center pixel of original item i (0-based) relative to carousel
            function origCenter(i) {
                const item = allItems[count + i];
                return item.offsetLeft + item.offsetWidth / 2;
            }

            // Width of one full set = distance between matching items in prepend vs originals
            function setWidth() {
                return allItems[count].offsetLeft - allItems[0].offsetLeft;
            }

            let scrollPx = 0;
            let animating = false;
            let dragging = false;
            let dragStartX = 0;
            let dragStartScroll = 0;
            let dragMoved = false;

            function applyTransform(animate) {
                const tx = getNavWidth() / 2 - scrollPx;
                if (animate) carousel.classList.add('animating');
                else carousel.classList.remove('animating');
                carousel.style.transform = `translateX(${tx}px)`;
            }

            // Wrap scrollPx back into originals range (invisible reset)
            function wrapScroll() {
                const sw = setWidth();
                const lo = origCenter(0);
                const hi = origCenter(count - 1);
                if (scrollPx < lo - sw * 0.4) scrollPx += sw;
                else if (scrollPx > hi + sw * 0.4) scrollPx -= sw;
                applyTransform(false);
            }

            // Find which original index (0..count-1) is closest to current scrollPx
            function nearestOrigIndex() {
                const sw = setWidth();
                let bestIdx = 0, bestDist = Infinity;
                for (let i = 0; i < count; i++) {
                    for (const offset of [-sw, 0, sw]) {
                        const d = Math.abs(scrollPx - (origCenter(i) + offset));
                        if (d < bestDist) { bestDist = d; bestIdx = i; }
                    }
                }
                return bestIdx;
            }

            // Scroll to center original item idx, using shortest path via clones
            function scrollToItem(idx, animate) {
                const sw = setWidth();
                const candidates = [origCenter(idx) - sw, origCenter(idx), origCenter(idx) + sw];
                let best = candidates[1], bestDist = Math.abs(scrollPx - best);
                for (const c of candidates) {
                    const d = Math.abs(scrollPx - c);
                    if (d < bestDist) { bestDist = d; best = c; }
                }
                if (animate) animating = true;
                scrollPx = best;
                applyTransform(animate);
                if (!animate) wrapScroll();
            }

            // Initialize: center on first active item
            const activeOrig = origItems.findIndex(el => el.classList.contains('active'));
            scrollPx = origCenter(activeOrig >= 0 ? activeOrig : 0);
            applyTransform(false);

            carousel.addEventListener('transitionend', () => {
                animating = false;
                wrapScroll();
            });

            // Shift by one item in given direction
            function shift(dir) {
                if (animating) return;
                const cur = nearestOrigIndex();
                const next = ((cur + dir) % count + count) % count;
                scrollToItem(next, true);
            }

            // Snap to nearest item after drag
            function snapToNearest(animate) {
                scrollToItem(nearestOrigIndex(), animate);
            }

            // --- MOUSE WHEEL ---
            nav.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (animating || dragging) return;
                shift(e.deltaY > 0 || e.deltaX > 0 ? 1 : -1);
            }, { passive: false });

            // --- MOUSE DRAG ---
            nav.addEventListener('mousedown', (e) => {
                if (animating) return;
                dragging = true;
                dragMoved = false;
                dragStartX = e.clientX;
                dragStartScroll = scrollPx;
                carousel.classList.remove('animating');
                nav.style.cursor = 'grabbing';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!dragging) return;
                const dx = e.clientX - dragStartX;
                if (Math.abs(dx) > 3) dragMoved = true;
                scrollPx = dragStartScroll - dx;
                carousel.style.transform = `translateX(${getNavWidth() / 2 - scrollPx}px)`;
            });

            document.addEventListener('mouseup', () => {
                if (!dragging) return;
                dragging = false;
                nav.style.cursor = '';
                if (dragMoved) snapToNearest(true);
            });

            // --- TOUCH DRAG ---
            let touchId = null;
            nav.addEventListener('touchstart', (e) => {
                if (animating) return;
                touchId = e.touches[0].identifier;
                dragging = true;
                dragMoved = false;
                dragStartX = e.touches[0].clientX;
                dragStartScroll = scrollPx;
                carousel.classList.remove('animating');
            }, { passive: true });

            nav.addEventListener('touchmove', (e) => {
                if (!dragging) return;
                const touch = [...e.touches].find(t => t.identifier === touchId);
                if (!touch) return;
                const dx = touch.clientX - dragStartX;
                if (Math.abs(dx) > 3) dragMoved = true;
                scrollPx = dragStartScroll - dx;
                carousel.style.transform = `translateX(${getNavWidth() / 2 - scrollPx}px)`;
            }, { passive: true });

            nav.addEventListener('touchend', () => {
                if (!dragging) return;
                dragging = false;
                if (dragMoved) snapToNearest(true);
            }, { passive: true });

            // --- CLICK: activate section + center item ---
            const SECTION_NAMES = {
                '1': 'Dane', '2': 'Podsumowanie', '3': 'AI Asystent',
                '4': 'Wykresy', '5': 'Ustawienia', '6': 'Predykcja'
            };

            function activateSection(sectionNum) {
                // üìä GA4: ≈õled≈∫ klikniƒôcia w zak≈Çadki
                if (typeof window.trackEvent === 'function') {
                    window.trackEvent('tab_click', {
                        event_category: 'navigation',
                        event_label: SECTION_NAMES[sectionNum] || `Sekcja ${sectionNum}`,
                        section_number: sectionNum
                    });
                }

                allItems.forEach(n => {
                    n.classList.toggle('active', n.dataset.section === sectionNum);
                });

                sections.forEach(s => {
                    s.style.display = 'none';
                    s.classList.remove('active');
                });
                const target = document.querySelector(`.app-section[data-section="${sectionNum}"]`);
                if (target) {
                    target.style.display = 'block';
                    target.classList.add('active');
                }

                // Center the clicked section in carousel
                const idx = sectionOrder.indexOf(sectionNum);
                if (idx >= 0) scrollToItem(idx, true);

                if (sectionNum === '4' && window._renderCharts) {
                    window._renderCharts();
                }

                // Sekcja AI Asystent ‚Äî poka≈º overlay "w budowie" (je≈õli w≈ÇƒÖczone)
                if (sectionNum === '3') {
                    const vis = JSON.parse(localStorage.getItem('uiVisibility') || '{}');
                    const overlay = document.getElementById('aiWipOverlay');
                    if (overlay) {
                        if (vis.notifyAiWip !== false) {
                            overlay.classList.remove('hidden');
                        } else {
                            overlay.classList.add('hidden');
                        }
                    }
                }

                // Sekcja Dane ‚Äî poka≈º overlay "zasada pracy na danych" (je≈õli w≈ÇƒÖczone)
                if (sectionNum === '1') {
                    const vis = JSON.parse(localStorage.getItem('uiVisibility') || '{}');
                    const overlay = document.getElementById('dataWorkflowOverlay');
                    if (overlay) {
                        if (vis.notifyDataWorkflow !== false) {
                            overlay.classList.remove('hidden');
                        } else {
                            overlay.classList.add('hidden');
                        }
                    }
                }
            }

            nav.addEventListener('click', (e) => {
                if (dragMoved) return;
                const item = e.target.closest('.nav-item');
                if (!item) return;
                activateSection(item.dataset.section);
            });

            // Expose for AI button and external navigation
            window._navActivateSection = activateSection;

            // WIP overlay ‚Äî zamknij przyciskiem
            const wipCloseBtn = document.getElementById('aiWipCloseBtn');
            if (wipCloseBtn) {
                wipCloseBtn.addEventListener('click', () => {
                    const overlay = document.getElementById('aiWipOverlay');
                    if (overlay) overlay.classList.add('hidden');
                });
            }

            // Data workflow overlay ‚Äî zamknij przyciskiem
            const dataWorkflowCloseBtn = document.getElementById('dataWorkflowCloseBtn');
            if (dataWorkflowCloseBtn) {
                dataWorkflowCloseBtn.addEventListener('click', () => {
                    const overlay = document.getElementById('dataWorkflowOverlay');
                    if (overlay) overlay.classList.add('hidden');
                });
            }
        });
    </script>
    
    <!-- AI Chat Button - Navigate to configured section -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const aiChatBtn = document.getElementById('aiChatBtn');
            if (aiChatBtn) {
                aiChatBtn.addEventListener('click', () => {
                    let target = '3';
                    try {
                        const vis = JSON.parse(localStorage.getItem('uiVisibility') || '{}');
                        if (vis.btnAiTarget) target = vis.btnAiTarget;
                    } catch { /* default */ }
                    const nav = document.querySelector(`.nav-item[data-section="${target}"]`);
                    if (nav) nav.click();
                });
            }
        });
    </script>
    
    <!-- Floating Console Logic -->
    <script>
        const floatingPanel = document.getElementById('floatingConsolePanel');
        const closeBtn = document.getElementById('closeFloatingConsole');
        const consoleSection = document.getElementById('consoleSection');
        
        // Function to toggle console
        const toggleConsole = () => {
            const isVisible = getComputedStyle(floatingPanel).display !== 'none';
            floatingPanel.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) {
                const lamp = document.getElementById('consoleLamp');
                if (lamp) lamp.className = 'floating-lamp floating-lamp-ok';
                // Scroll to bottom so newest logs are visible
                const apiLogs = document.getElementById('apiLogs');
                const floatingLogs = document.getElementById('floatingConsoleLogs');
                if (apiLogs) apiLogs.scrollTop = apiLogs.scrollHeight;
                if (floatingLogs) floatingLogs.scrollTop = floatingLogs.scrollHeight;
            }
        };
        
        // Console section click (from floating bar)
        consoleSection?.addEventListener('click', toggleConsole);
        
        // Console keyboard shortcut: Ctrl+`
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === '`') {
                e.preventDefault();
                toggleConsole();
            }
        });
        
        closeBtn?.addEventListener('click', () => {
            floatingPanel.style.display = 'none';
        });
        
        // Simple sync function for logs (called by console interceptor)
        window.syncFloatingConsoleLogs = function() {
            const mainLogs = document.getElementById('apiLogs');
            const floatingLogs = document.getElementById('floatingConsoleLogs');
            if (mainLogs && floatingLogs) {
                floatingLogs.innerHTML = mainLogs.innerHTML;
                floatingLogs.scrollTop = floatingLogs.scrollHeight;
            }
        }
        
        // Initialize UI elements when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[DOMContentLoaded] Starting UI initialization');
            
            // Flush console buffer
            const apiLogs = document.getElementById('apiLogs');
            if (window.logBuffer.length > 0 && apiLogs) {
                apiLogs.innerHTML = '';
                
                window.logBuffer.forEach(entry => {
                    const line = document.createElement('div');
                    line.textContent = typeof entry === 'string' ? entry : entry.text;
                    line.style.fontSize = '0.85rem';
                    line.style.fontFamily = 'monospace';
                    line.style.lineHeight = '1.6';
                    const entryColor = (typeof entry === 'object' && entry.color) ? entry.color : null;
                    line.style.color = entryColor || LOG_COLORS.default;
                    if (!entryColor) line.setAttribute('data-default-color', '');
                    apiLogs.appendChild(line);
                });
                
                window.logBuffer = [];
                apiLogs.scrollTop = apiLogs.scrollHeight;
                window.syncFloatingConsoleLogs && window.syncFloatingConsoleLogs();
            }
            
            // Get all button elements
            const importDbBtn = document.getElementById('importDbBtn');
            const exportDbBtn = document.getElementById('exportDbBtn');
            const aboutBtn = document.getElementById('aboutBtn');
            const languageBtn = document.getElementById('languageBtn');
            const helpBtn = document.getElementById('helpBtn');
            
            console.log('[DOMContentLoaded] Elements found:',
                'importDbBtn:', !!importDbBtn,
                'exportDbBtn:', !!exportDbBtn,
                'aboutBtn:', !!aboutBtn,
                'languageBtn:', !!languageBtn,
                'helpBtn:', !!helpBtn
            );
            
            // Helper function to add button animation and click handler
            const addButtonAnimation = (btn, clickHandler) => {
                if (!btn) return;
                
                btn.addEventListener('mouseenter', () => {
                    btn.style.transform = 'scale(1.1)';
                });
                btn.addEventListener('mouseleave', () => {
                    btn.style.transform = 'scale(1)';
                });
                btn.addEventListener('click', () => {
                    btn.style.transform = 'scale(0.9)';
                    setTimeout(() => btn.style.transform = 'scale(1)', 200);
                    clickHandler();
                });
            };
            
            // Attach button listeners with animation
            addButtonAnimation(aboutBtn, () => {
                ToastModule.info(
                    'Autor: Micha≈Ç Stankiewicz (tel. 797 486 355)\n\n' +
                    'üìò <a href="https://www.facebook.com/parlamentpimp" target="_blank" style="color:#4a9eff">Facebook</a>\n' +
                    'üé¨ <a href="https://www.youtube.com/@ParlamentPIMP" target="_blank" style="color:#4a9eff">YouTube</a>\n' +
                    'üíª <a href="https://github.com/michalstankiewicz4-cell/NostraDamnOS/discussions" target="_blank" style="color:#4a9eff">GitHub Discussions</a>\n\n' +
                    'Osoby kt√≥re wspierajƒÖ: Robin070\n\n' +
                    'Pomoc w realizacji: Tomasz Gierczak, xBigle22x, szauw_iks',
                    { title: 'Parlament P.I.M.P. - Parliamentary Intelligence & Monitoring Platform', duration: 10000, rawHtml: true }
                );
            });
            
            addButtonAnimation(languageBtn, () => {
                console.log('üáµüá± TODO: Zmiana jƒôzyka');
                ToastModule.info('Funkcja w przygotowaniu (TODO v5.0)', { title: 'üáµüá± Zmiana jƒôzyka' });
            });
            
            addButtonAnimation(helpBtn, () => {
                console.log('‚ùì Starting interactive tour...');
                if (window.startInteractiveTour) {
                    window.startInteractiveTour();
                } else {
                    ToastModule.warning('Tour system not loaded yet', { title: 'Please wait...' });
                }
            });

            const resetMemoryBtn = document.getElementById('resetMemoryBtn');
            addButtonAnimation(resetMemoryBtn, () => {
                if (confirm('Czy na pewno chcesz zresetowaƒá pamiƒôƒá przeglƒÖdarki?\n\nTo usunie zapisane pozycje przycisk√≥w i ustawienia interfejsu.')) {
                    import('./modules/floating-drag.js').then(m => m.resetFloatingButtonPositions());
                    localStorage.removeItem('uiVisibility');
                    localStorage.removeItem('nostradamnos_etlSettings');
                    location.reload();
                }
            });

            // Summary import/export buttons ‚Üí proxy to floating buttons
            document.getElementById('summaryImportDb')?.addEventListener('click', () => {
                document.getElementById('importDbBtn')?.click();
            });
            document.getElementById('summaryExportDb')?.addEventListener('click', () => {
                document.getElementById('exportDbBtn')?.click();
            });

            // Language buttons (TODO)
            ['langPL', 'langEN', 'langUA'].forEach(id => {
                document.getElementById(id)?.addEventListener('click', () => {
                    ToastModule.info('Funkcja w przygotowaniu (TODO v5.0)', { title: 'üáµüá± Zmiana jƒôzyka' });
                });
            });

            // Chart no-data action buttons
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('[data-action]');
                if (!btn) return;
                
                // Sprawd≈∫ czy przycisk jest zablokowany
                if (btn.disabled) return;
                
                const action = btn.dataset.action;
                if (action === 'goto-etl') {
                    // Przejd≈∫ do sekcji ETL (sekcja 1)
                    if (window._navActivateSection) {
                        window._navActivateSection('1');
                    } else {
                        // Fallback je≈õli funkcja nawigacji jeszcze nie jest dostƒôpna
                        const navItem = document.querySelector('.nav-item[data-section="1"]');
                        if (navItem) navItem.click();
                    }
                    // Przewi≈Ñ do g√≥ry sekcji ETL
                    setTimeout(() => {
                        const etlSection = document.querySelector('.app-section[data-section="1"]');
                        if (etlSection) {
                            etlSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }
                    }, 100);
                } else if (action === 'import-db') {
                    // Sprawd≈∫ czy kolejka zada≈Ñ dzia≈Ça
                    if (window.taskQueue?.isRunning()) {
                        import('./modules/toast.js').then(m => {
                            m.default.info('Poczekaj na zako≈Ñczenie sprawdzania danych...', { duration: 2000 });
                        });
                        return;
                    }
                    // Kliknij przycisk importu bazy
                    const importBtn = document.getElementById('importDbBtn');
                    if (importBtn) {
                        importBtn.click();
                    } else {
                        console.error('[Chart Action] importDbBtn not found in DOM!');
                    }
                }
            });

            console.log('[DOMContentLoaded] Initialization complete');
        });
    </script>
    <script type="module">
        import { initDbButtons } from './modules/db-buttons.js';
        
        // Inicjalizuj przyciski bazy po za≈Çadowaniu DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initDbButtons();
            });
        } else {
            initDbButtons();
        }
    </script>
    <script type="module">
        import { renderAllCharts, initChartCards } from './modules/charts.js';
        import { initChartsManager } from './modules/charts-manager.js';
        import { initPredictions } from './modules/predictions.js';
        import { initHelp } from './modules/help.js';
        
        window._renderCharts = renderAllCharts;
        
        // Inicjalizuj manager wykres√≥w po za≈Çadowaniu DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                // Daj czas aby wykresy zosta≈Çy dodane do DOM
                setTimeout(() => {
                    initChartsManager();
                    initChartCards();
                    initPredictions();
                    initHelp();
                }, 100);
            });
        } else {
            setTimeout(() => {
                initChartsManager();
                initChartCards();
                initPredictions();
                initHelp();
            }, 100);
        }
    </script>

    <script type="module">
        // EmoGame ‚Äî preload module so window.startEmoGame / stopEmoGame are available
        import './modules/emogame.js';
    </script>

    <script type="module">
        import { initAIChat } from './modules/ai-chat.js';

        // Initialize AI Chat after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initAIChat);
        } else {
            initAIChat();
        }
    </script>

    <!-- Top Info Bar ‚Äî scrolling help messages -->
    <script>
    (function() {
        const messages = [
            '≈öciƒÖgnij dane do analizy w zak≈Çadce ETL ‚Äî zaznacz interesujƒÖce Ciƒô dane oraz kliknij przycisk "Pobierz dane"',
            'Porozmawiaj z asystentem AI, aby uzyskaƒá analizƒô pobranych danych parlamentarnych',
            'Sprawd≈∫ statystyki g≈Çosowa≈Ñ i frekwencjƒô pos≈Ç√≥w w zak≈Çadce Analiza',
            'Por√≥wnaj wypowiedzi pos≈Ç√≥w na wybrany temat za pomocƒÖ narzƒôdzia por√≥wnania',
            'Dostosuj wyglƒÖd aplikacji w zak≈Çadce Ustawienia ‚Äî wybierz styl Jasny, Ciemny lub Retro'
        ];

        const textEl = document.getElementById('topInfoText');
        if (!textEl) return;

        let idx = 0;

        function showNext() {
            textEl.classList.add('reset');
            textEl.textContent = messages[idx];
            void textEl.offsetWidth;
            textEl.classList.remove('reset');
            idx = (idx + 1) % messages.length;
        }

        textEl.addEventListener('animationend', function() {
            setTimeout(showNext, 3000);
        });

        showNext();
    })();
    </script>

    <!-- Settings: UI visibility toggles -->
    <script>
    (function() {
        const STORAGE_KEY = 'uiVisibility';

        const defaults = {
            floatingBtns: true,
            topBar: true,
            bottomBar: true,
            btnImport: true,
            btnExport: true,
            btnAi: true,
            btnAiTarget: '3',
            btnAbout: true,
            btnHelp: true,
            btnLanguage: false,
            btnReset: false,
            barVersion: true,
            barAi: true,
            barLoad: true,
            barMemory: false,
            barStorage: false,
            barCache: true,
            barConsole: true,
            barLive: false,
            dbCheckNewRecords: false,
            dbCheckNewRecordsInterval: 5,
            dbCheckDataChanges: false,
            dbCheckDataChangesInterval: 11,
            infoFetch: true,
            rememberEtl: false,
            soundAlerts: true,
            fetchSpeed: 'normal',
            notifyDataWorkflow: true,
            notifyAiWip: true,
            gameOnLoad: false,
            gameLiteMode: true
        };

        function load() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    return { ...defaults, ...JSON.parse(saved) };
                } else {
                    // Je≈õli nie ma zapisanych ustawie≈Ñ, zapisz defaults
                    const state = { ...defaults };
                    save(state);
                    return state;
                }
            } catch { 
                const state = { ...defaults };
                save(state);
                return state;
            }
        }

        function save(state) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        function apply(state) {
            // Floating buttons ‚Äî delegate to UI mode manager (handles master toggle + per-button)
            if (typeof window._updateUIMode === 'function') {
                window._updateUIMode();
            }

            // Top info bar
            const topBar = document.getElementById('topInfoBar');
            if (topBar) topBar.style.display = state.topBar ? '' : 'none';
            document.body.style.paddingTop = state.topBar ? '27px' : '0';

            // Bottom floating status bar
            const bottomBar = document.getElementById('floatingStatusBar');
            if (bottomBar) bottomBar.style.display = state.bottomBar ? '' : 'none';
            document.body.style.paddingBottom = state.bottomBar ? '25px' : '0';

            // Individual bar sections
            const barSections = [
                { key: 'barAi', id: 'aiStatusSection' },
                { key: 'barLoad', id: 'etlProgressSection' },
                { key: 'barMemory', id: 'memorySection' },
                { key: 'barStorage', id: 'storageSection' },
                { key: 'barCache', id: 'cacheSection' },
                { key: 'barLive', id: 'liveSection' },
                { key: 'barConsole', id: 'consoleSection' }
            ];
            for (const { key, id } of barSections) {
                const el = document.getElementById(id);
                if (!el) continue;
                el.style.display = state[key] ? '' : 'none';
                const prev = el.previousElementSibling;
                if (prev && prev.classList.contains('status-bar-separator')) {
                    prev.style.display = state[key] ? '' : 'none';
                }
            }

            // Refresh info panel sections visibility
            if (window.refreshInfoPanelSections) {
                window.refreshInfoPanelSections();
            }
        }

        const state = load();

        const chkTop = document.getElementById('toggleTopBar');
        const chkBottom = document.getElementById('toggleBottomBar');

        if (chkTop) chkTop.checked = state.topBar;
        if (chkBottom) chkBottom.checked = state.bottomBar;

        // Per-button checkboxes
        const btnToggles = [
            { key: 'btnImport', id: 'toggleBtnImport' },
            { key: 'btnExport', id: 'toggleBtnExport' },
            { key: 'btnAi', id: 'toggleBtnAi' },
            { key: 'btnAbout', id: 'toggleBtnAbout' },
            { key: 'btnHelp', id: 'toggleBtnHelp' },
            { key: 'btnLanguage', id: 'toggleBtnLanguage' },
            { key: 'btnReset', id: 'toggleBtnReset' }
        ];
        for (const { key, id } of btnToggles) {
            const chk = document.getElementById(id);
            if (chk) chk.checked = !!state[key];
        }

        // AI button target select + icon sync
        const sectionIcons = { '1': 'üì•', '2': 'üìä', '3': 'ü§ñ', '4': 'üìà', '5': '‚öôÔ∏è' };
        const aiTargetSelect = document.getElementById('btnAiTargetSelect');
        const aiBtn = document.getElementById('aiChatBtn');
        function updateAiBtnIcon(target) {
            if (aiBtn && sectionIcons[target]) aiBtn.textContent = sectionIcons[target];
        }
        if (aiTargetSelect) {
            const savedTarget = state.btnAiTarget || '3';
            aiTargetSelect.value = savedTarget;
            updateAiBtnIcon(savedTarget);
            aiTargetSelect.addEventListener('change', function() {
                state.btnAiTarget = this.value;
                save(state);
                updateAiBtnIcon(this.value);
            });
        }

        // Bar section checkboxes
        const barToggles = [
            { key: 'barAi', id: 'toggleBarAi' },
            { key: 'barLoad', id: 'toggleBarLoad' },
            { key: 'barMemory', id: 'toggleBarMemory' },
            { key: 'barStorage', id: 'toggleBarStorage' },
            { key: 'barCache', id: 'toggleBarCache' },
            { key: 'barLive', id: 'toggleBarLive' },
            { key: 'barConsole', id: 'toggleBarConsole' }
        ];
        for (const { key, id } of barToggles) {
            const chk = document.getElementById(id);
            if (chk) chk.checked = !!state[key];
        }

        // Info panel toggles
        const chkInfoFetch = document.getElementById('toggleInfoFetch');
        if (chkInfoFetch) chkInfoFetch.checked = !!state.infoFetch;

        // Database monitoring toggles
        const chkDbCheckNewRecords = document.getElementById('toggleDbCheckNewRecords');
        if (chkDbCheckNewRecords) chkDbCheckNewRecords.checked = !!state.dbCheckNewRecords;
        const inputDbCheckNewRecordsInterval = document.getElementById('dbCheckNewRecordsInterval');
        if (inputDbCheckNewRecordsInterval) inputDbCheckNewRecordsInterval.value = state.dbCheckNewRecordsInterval || 5;
        
        const chkDbCheckDataChanges = document.getElementById('toggleDbCheckDataChanges');
        if (chkDbCheckDataChanges) chkDbCheckDataChanges.checked = !!state.dbCheckDataChanges;
        const inputDbCheckDataChangesInterval = document.getElementById('dbCheckDataChangesInterval');
        if (inputDbCheckDataChangesInterval) inputDbCheckDataChangesInterval.value = state.dbCheckDataChangesInterval || 11;

        apply(state);
        
        // Initialize lamps visibility based on settings
        if (window.updateLampsVisibility) {
            window.updateLampsVisibility();
        }

        function onToggle(key, checkbox) {
            if (!checkbox) return;
            checkbox.addEventListener('change', function() {
                state[key] = this.checked;
                save(state);
                apply(state);
                if (typeof window.trackEvent === 'function') {
                    window.trackEvent('settings_change', { setting_name: key, setting_value: this.checked });
                }
            });
        }

        onToggle('topBar', chkTop);
        onToggle('bottomBar', chkBottom);
        for (const { key, id } of btnToggles) {
            onToggle(key, document.getElementById(id));
        }
        for (const { key, id } of barToggles) {
            onToggle(key, document.getElementById(id));
        }
        onToggle('infoFetch', chkInfoFetch);

        // Database monitoring toggles with restart callback
        if (chkDbCheckNewRecords) {
            chkDbCheckNewRecords.addEventListener('change', function() {
                state.dbCheckNewRecords = this.checked;
                save(state);
                if (window.updateLampsVisibility) window.updateLampsVisibility();
                if (window.restartDbMonitoring) window.restartDbMonitoring();
            });
        }
        if (inputDbCheckNewRecordsInterval) {
            inputDbCheckNewRecordsInterval.addEventListener('change', function() {
                state.dbCheckNewRecordsInterval = parseInt(this.value) || 5;
                save(state);
                if (window.restartDbMonitoring) window.restartDbMonitoring();
            });
        }
        if (chkDbCheckDataChanges) {
            chkDbCheckDataChanges.addEventListener('change', function() {
                state.dbCheckDataChanges = this.checked;
                save(state);
                if (window.updateLampsVisibility) window.updateLampsVisibility();
                if (window.restartDbMonitoring) window.restartDbMonitoring();
            });
        }
        if (inputDbCheckDataChangesInterval) {
            inputDbCheckDataChangesInterval.addEventListener('change', function() {
                state.dbCheckDataChangesInterval = parseInt(this.value) || 11;
                save(state);
                if (window.restartDbMonitoring) window.restartDbMonitoring();
            });
        }

        // Force check buttons - u≈ºywajƒÖ debounce z api-handler-v2.js
        const btnCheckNewRecords = document.getElementById('btnCheckNewRecords');
        if (btnCheckNewRecords) {
            btnCheckNewRecords.addEventListener('click', function() {
                if (window.forceCheckNewRecords) window.forceCheckNewRecords();
            });
        }
        
        const btnCheckDataChanges = document.getElementById('btnCheckDataChanges');
        if (btnCheckDataChanges) {
            btnCheckDataChanges.addEventListener('click', function() {
                if (window.forceCheckDataChanges) window.forceCheckDataChanges();
            });
        }

        // Remember ETL settings toggle
        const chkRememberEtl = document.getElementById('toggleRememberEtl');
        if (chkRememberEtl) chkRememberEtl.checked = !!state.rememberEtl;
        onToggle('rememberEtl', chkRememberEtl);

        // Auto count records on startup toggle
        const chkAutoCount = document.getElementById('toggleAutoCountRecords');
        if (chkAutoCount) {
            chkAutoCount.checked = state.autoCountRecords !== false;
            chkAutoCount.addEventListener('change', function() {
                state.autoCountRecords = this.checked;
                save(state);
                if (this.checked) {
                    // W≈ÇƒÖczono ‚Äî odpytaj API o ilo≈õci
                    window._updateTranscriptsCount?.();
                    window._updateVotingsCount?.();
                    window._updatePerTermCounts?.();
                    window._loadCommitteeOptions?.();
                    const reqRow = document.querySelector('.estimate-row-requests');
                    if (reqRow) reqRow.style.display = '';
                } else {
                    // Wy≈ÇƒÖczono ‚Äî wyczy≈õƒá spany z liczbami + ukryj wiersz request√≥w
                    const spanIds = [
                        'etlTranscriptsCount', 'etlVotingsCount', 'etlVotesCount',
                        'etlInterpellationsCount', 'etlWrittenQuestionsCount',
                        'etlBillsCount', 'etlLegalActsCount',
                        'etlCommitteeSittingsCount', 'etlCommitteeStatementsCount'
                    ];
                    spanIds.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = '';
                    });
                    const reqRow = document.querySelector('.estimate-row-requests');
                    if (reqRow) reqRow.style.display = 'none';
                    if (window._updateETLEstimate) window._updateETLEstimate();
                }
            });
        }
        window._shouldAutoCountRecords = () => (state.autoCountRecords !== false);

        // Ustaw widoczno≈õƒá wiersza request√≥w wed≈Çug autoCountRecords
        const reqRowInit = document.querySelector('.estimate-row-requests');
        if (reqRowInit) reqRowInit.style.display = (state.autoCountRecords !== false) ? '' : 'none';

        // Show estimate: pamiƒôƒá i czas
        const chkShowEstimate = document.getElementById('toggleShowEstimate');
        if (chkShowEstimate) {
            chkShowEstimate.checked = state.showEstimate !== false;
            const applyEstimate = (show) => {
                const sizeBadges = document.querySelectorAll('.badge-size');
                const sizeRow = document.querySelector('.estimate-row-size');
                const timeRow = document.querySelector('.estimate-row-time');
                sizeBadges.forEach(b => b.style.display = show ? '' : 'none');
                if (sizeRow) sizeRow.style.display = show ? '' : 'none';
                if (timeRow) timeRow.style.display = show ? '' : 'none';
                // Ukryj ca≈Çy box je≈õli obie opcje wy≈ÇƒÖczone
                const reqsVisible = state.autoCountRecords !== false;
                const box = document.querySelector('.estimate-box');
                if (box) box.style.display = (!show && !reqsVisible) ? 'none' : '';
            };
            applyEstimate(chkShowEstimate.checked);
            chkShowEstimate.addEventListener('change', function() {
                state.showEstimate = this.checked;
                save(state);
                applyEstimate(this.checked);
                if (this.checked && window._updateETLEstimate) window._updateETLEstimate();
            });
        }
        window._shouldShowEstimate = () => (state.showEstimate !== false || state.autoCountRecords !== false);

        // Sound alerts toggle (syncs to separate key for fetcher.js)
        const chkSoundAlerts = document.getElementById('toggleSoundAlerts');
        if (chkSoundAlerts) {
            chkSoundAlerts.checked = state.soundAlerts !== false;
            localStorage.setItem('nostradamnos_soundAlerts', chkSoundAlerts.checked ? 'true' : 'false');
            chkSoundAlerts.addEventListener('change', function() {
                state.soundAlerts = this.checked;
                save(state);
                localStorage.setItem('nostradamnos_soundAlerts', this.checked ? 'true' : 'false');
            });
        }

        // Fetch speed radio (stored in settings state, exposed globally)
        const speedRadios = document.querySelectorAll('input[name="settingsSpeed"]');
        const currentSpeed = state.fetchSpeed || 'normal';
        speedRadios.forEach(radio => {
            if (radio.value === currentSpeed) radio.checked = true;
            radio.addEventListener('change', function() {
                state.fetchSpeed = this.value;
                save(state);
            });
        });
        // Expose for pipeline.js buildConfigFromUI
        window._getSettingsFetchSpeed = () => state.fetchSpeed || 'normal';

        // Notification toggles (overlays)
        const chkNotifyDataWorkflow = document.getElementById('toggleNotifyDataWorkflow');
        if (chkNotifyDataWorkflow) chkNotifyDataWorkflow.checked = state.notifyDataWorkflow !== false;
        onToggle('notifyDataWorkflow', chkNotifyDataWorkflow);

        const chkNotifyAiWip = document.getElementById('toggleNotifyAiWip');
        if (chkNotifyAiWip) chkNotifyAiWip.checked = state.notifyAiWip !== false;
        onToggle('notifyAiWip', chkNotifyAiWip);

        // Game on load toggle
        const chkGameOnLoad = document.getElementById('toggleGameOnLoad');
        if (chkGameOnLoad) chkGameOnLoad.checked = !!state.gameOnLoad;
        onToggle('gameOnLoad', chkGameOnLoad);

        // Game lite mode toggle
        const chkGameLite = document.getElementById('toggleGameLite');
        if (chkGameLite) chkGameLite.checked = state.gameLiteMode !== false;
        onToggle('gameLiteMode', chkGameLite);

        // Analytics consent toggle
        const chkAnalytics = document.getElementById('toggleAnalyticsConsent');
        if (chkAnalytics) {
            chkAnalytics.checked = localStorage.getItem('analytics_consent') === 'granted';
            chkAnalytics.addEventListener('change', function() {
                const value = this.checked ? 'granted' : 'denied';
                localStorage.setItem('analytics_consent', value);
                if (typeof gtag === 'function') {
                    gtag('consent', 'update', { analytics_storage: value });
                }
            });
        }

        // Emoclippy toggle
        const chkEmoclippy = document.getElementById('toggleEmoclippy');
        if (chkEmoclippy) {
            chkEmoclippy.checked = localStorage.getItem('emoclippy_enabled') !== 'false';
            chkEmoclippy.addEventListener('change', function() {
                localStorage.setItem('emoclippy_enabled', this.checked ? 'true' : 'false');
            });
        }

        // ETL settings persistence
        const ETL_SETTINGS_KEY = 'nostradamnos_etlSettings';

        const etlCheckboxIds = [
            'etlTranscripts', 'etlVotings', 'etlVotes',
            'etlInterpellations', 'etlWrittenQuestions', 'etlBills',
            'etlLegalActs', 'etlDisclosures', 'etlCommitteeSittings'
        ];

        function saveEtlSettings() {
            if (!state.rememberEtl || _restoringEtl) return;
            const settings = {
                inst: document.querySelector('input[name="etlInst"]:checked')?.value || 'sejm',
                term: document.getElementById('etlTermSelect')?.value || '10',
                rangeFrom: document.getElementById('etlRangeFrom')?.value || '1',
                rangeTo: document.getElementById('etlRangeTo')?.value || '3',
                fetchSpeed: (typeof window._getSettingsFetchSpeed === 'function' ? window._getSettingsFetchSpeed() : 'normal'),
                checkboxes: {},
                committees: Array.from(document.getElementById('etlCommitteeSelect')?.selectedOptions || []).map(o => o.value)
            };
            for (const id of etlCheckboxIds) {
                const cb = document.getElementById(id);
                if (cb) settings.checkboxes[id] = cb.checked;
            }
            // RSS checkboxes
            settings.rssCheckboxes = {};
            const rssPanel = document.getElementById('rssPanel');
            if (rssPanel) {
                rssPanel.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    if (cb.id) settings.rssCheckboxes[cb.id] = cb.checked;
                });
            }
            localStorage.setItem(ETL_SETTINGS_KEY, JSON.stringify(settings));
        }

        let _restoringEtl = false;

        function restoreEtlSettings() {
            if (!state.rememberEtl) return;
            try {
                const raw = localStorage.getItem(ETL_SETTINGS_KEY);
                if (!raw) return;
                const s = JSON.parse(raw);
                _restoringEtl = true;

                // Institution (set without dispatching ‚Äî avoids refetching terms)
                const instRadio = document.querySelector(`input[name="etlInst"][value="${s.inst}"]`);
                if (instRadio) {
                    instRadio.checked = true;
                    // Update UI panels (show RSS / hide Sejm fields etc.)
                    if (typeof window._toggleETLView === 'function') window._toggleETLView(s.inst);
                }

                // Term ‚Äî wait for options to load, then set
                const termSelect = document.getElementById('etlTermSelect');
                if (termSelect && s.term) {
                    const trySetTerm = () => {
                        if ([...termSelect.options].some(o => o.value === s.term)) {
                            termSelect.value = s.term;
                        }
                    };
                    trySetTerm();
                    // Retry after terms are fetched from API
                    setTimeout(trySetTerm, 1000);
                }

                // Range
                const rf = document.getElementById('etlRangeFrom');
                const rt = document.getElementById('etlRangeTo');
                if (rf && s.rangeFrom) rf.value = s.rangeFrom;
                if (rt && s.rangeTo) rt.value = s.rangeTo;

                // Speed ‚Äî teraz w ustawieniach, pomijamy w ETL restore

                // Checkboxes
                if (s.checkboxes) {
                    for (const [id, checked] of Object.entries(s.checkboxes)) {
                        const cb = document.getElementById(id);
                        if (cb && !cb.disabled) cb.checked = checked;
                    }
                }

                // RSS checkboxes
                if (s.rssCheckboxes) {
                    for (const [id, checked] of Object.entries(s.rssCheckboxes)) {
                        const cb = document.getElementById(id);
                        if (cb) cb.checked = checked;
                    }
                }

                // Re-apply dependencies after restoring checkboxes
                if (typeof window._applyEtlDependencies === 'function') window._applyEtlDependencies();

                // Committees ‚Äî trigger load, then set saved selections after options arrive
                const comSel = document.getElementById('etlCommitteeSelect');
                if (comSel && typeof window._loadCommitteeOptions === 'function') {
                    window._loadCommitteeOptions().then(() => {
                        if (Array.isArray(s.committees) && s.committees.length > 0) {
                            for (const opt of comSel.options) {
                                opt.selected = s.committees.includes(opt.value);
                            }
                        }
                        _restoringEtl = false;
                    }).catch(() => { _restoringEtl = false; });
                } else {
                    _restoringEtl = false;
                }
            } catch { _restoringEtl = false; }
        }

        // Restore on load (after etl-bridge has initialized)
        window.addEventListener('etl-bridge-ready', restoreEtlSettings);
        // Fallback: restore after short delay if event not fired
        setTimeout(restoreEtlSettings, 500);

        // Save on any ETL input change
        window._saveEtlSettings = saveEtlSettings;
    })();
    </script>

    <!-- PIN Modal (Key Vault) -->
    <div id="pinModal" class="pin-modal-overlay" style="display:none;">
        <div class="pin-modal">
            <div class="pin-modal-header">
                <span class="pin-modal-icon">üîê</span>
                <h3 id="pinModalTitle">Ustaw PIN</h3>
            </div>
            <p id="pinModalDesc" class="pin-modal-desc">Ustaw 4‚Äì8 cyfrowy PIN aby zaszyfrowaƒá klucz API</p>
            <div class="pin-input-group">
                <label for="pinInput1" id="pinLabel1">PIN:</label>
                <input type="password" id="pinInput1" class="pin-input" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="off" />
            </div>
            <div class="pin-input-group" id="pinConfirmGroup">
                <label for="pinInput2">Potwierd≈∫ PIN:</label>
                <input type="password" id="pinInput2" class="pin-input" maxlength="8" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" inputmode="numeric" autocomplete="off" />
            </div>
            <div id="pinError" class="pin-error" style="display:none;"></div>
            <div class="pin-modal-actions">
                <button id="pinSubmitBtn" class="pin-btn pin-btn-primary">Zatwierd≈∫</button>
                <button id="pinCancelBtn" class="pin-btn pin-btn-secondary">Anuluj</button>
                <label class="pin-remember-label">
                    <input type="checkbox" id="pinDontSave" /> Nie zapamiƒôtuj klucza
                </label>
            </div>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelogModal" class="changelog-overlay" style="display:none;">
        <div class="wip-modal changelog-modal">
            <div class="wip-icon">üìã</div>
            <h3 class="wip-title">Historia wersji</h3>
            <div id="changelogContent" class="changelog-content"></div>
            <button id="changelogCloseBtn" class="wip-close-btn">Zamknij</button>
        </div>
    </div>

    <script type="module">
        import { CHANGELOG } from './modules/help-data.js';

        const modal   = document.getElementById('changelogModal');
        const content = document.getElementById('changelogContent');
        const changelogClose = document.getElementById('changelogCloseBtn');

        // Zbuduj wpisy
        if (content && CHANGELOG) {
            content.innerHTML = CHANGELOG.map(e => `
                <div class="changelog-entry">
                    <div class="changelog-version-row">
                        <span class="changelog-badge">${e.version}</span>
                        <span class="changelog-date">${e.date}</span>
                    </div>
                    <div class="changelog-desc">${e.desc}</div>
                    ${e.items ? '<ul class="changelog-items">' + e.items.map(i => `<li>${i}</li>`).join('') + '</ul>' : ''}
                </div>
            `).join('');
        }

        // Otw√≥rz po klikniƒôciu wersji w pasku
        document.getElementById('versionSection')?.addEventListener('click', () => {
            modal.style.display = 'flex';
        });

        // Zamknij
        changelogClose?.addEventListener('click', () => { modal.style.display = 'none'; });
        modal?.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
    </script>

</body>
</html>
